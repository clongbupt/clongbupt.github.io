<!doctype html>
<html class="theme-next use-motion">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>




  <link rel="stylesheet" type="text/css" href="vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="css/main.css?v=0.3.0rc5"/>


    <meta name="description" content="一个不会煮面的码农的自留地" />





    <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.3.0rc5" />




  <title> clongbupt的小窝 </title>
</head>

<body>
  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
    <a href="/" class="brand">
        <span class="logo">
          <i class="icon-logo"></i>
        </span>
        <span class="site-title">clongbupt的小窝</span>
    </a>
</h1>


  <ul id="menu" class="menu">
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          首页
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          归档
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          标签
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
            
          

          <div id="posts" class="posts-expand">
            
  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="2015/03/09/hello-world/">
                Hello World
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              发表于 2015-03-09
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

        

      </div>
    

    
      <div class="post-footer">
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="2015/02/17/Cloud-Foundry-社区周报/">
                Cloud Foundry 社区周报
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              发表于 2015-02-16
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <ol>
<li><p>上周最大的新闻是Cloud Foundry的新CEO上任，欢迎Sam Ramji！在加入Cloud Foundry之前Sam Ramji在Appigee工作，并有在微软设计和领导开源战略的经验。</p>
</li>
<li><p>在Youtube上的Cloud Foundry每周晚例会报告(Cloud Foundry After Dark hangout)</p>
<ul>
<li><p>企业级云发布管理工具Apache Brooklyn有望支持Cloud Foundry</p>
</li>
<li><p>Matt Stine 的新书 《Migrating to Cloud native App Architectures》</p>
</li>
<li><p>Cloudfoundry 的新运行时环境Diego示例介绍</p>
</li>
<li><p>Concouse.io 一个基于CF的CI解决方案介绍</p>
</li>
</ul>
</li>
</ol>
<p>晚例会观看地址：<a href="http://youtu.be/TY_qOyp27X4" target="_blank" rel="external">http://youtu.be/TY_qOyp27X4</a></p>
<ol>
<li><p>Edison 发布的关于 Bosh Lite 在 AWS 上部署的文章。链接: <a href="https://cloudfoundryideas.wordpress.com/2015/01/28/building-a-cloudfoundry-sandbox-environment-in-15-minutes/" target="_blank" rel="external">Bosh-Lite on AWS</a></p>
</li>
<li><p>支持函数式语言 Elixir 的 buildpack 发布。链接：<a href="https://groups.google.com/a/cloudfoundry.org/forum/#!topic/vcap-dev/dOZ9il25u3Y" target="_blank" rel="external">Elixir Buildpack for Cloud Foundry</a></p>
</li>
<li><p>Pivotal 发布了基于开源MySQL版本的CF版MySQL版。链接：<a href="http://blog.pivotal.io/cloud-foundry-pivotal/products/mysql-service-on-pivotal-cloud-foundry-now-highly-available" target="_blank" rel="external">MySQL service for Pivotal CF</a></p>
</li>
</ol>
<p>原文链接：<a href="http://www.thisweekincf.com/blog/2015/02/17/this-week-in-cloud-foundry-february-17th-2015/" target="_blank" rel="external">This Week in Cloud Foundry - February 17th 2015</a></p>
<blockquote>
<p>译者：clongbupt</p>
</blockquote>

        

      </div>
    

    
      <div class="post-footer">
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="2015/02/16/One-Method-to-Debug-Heartbeat-Cluster/">
                One_Method_to_Debug_Heartbeat_Cluster
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              发表于 2015-02-16
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          
        

      </div>
    

    
      <div class="post-footer">
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="2014/04/24/博客搭建架构/">
                博客搭建架构
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              发表于 2014-04-23
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>记录重新设计博客的点滴。</p>
<h2 id="前言">前言</h2><p>去年的这个时候搭了一个简陋的博客。因为太简陋，便没有更新。然后就计划着等有时间了，稍微搭理下。计划是一个下午搞定，不料进行的不太顺利，便有了这篇博客。</p>
<h3 id="准备工作">准备工作</h3><ul>
<li><p>Jekyll</p>
</li>
<li><p>github.io</p>
</li>
<li><p>Flatboot</p>
</li>
<li><p>代码高亮</p>
</li>
<li><p>留言</p>
</li>
<li><p>Grunt</p>
</li>
<li><p>Bower</p>
</li>
</ul>
<h2 id="Jekyll">Jekyll</h2><p>Jekyll是一个Ruby gems，可以在本地对github pages进行开发、调试，非常方便。</p>
<h3 id="安装">安装</h3><p>安装rbenv</p>
<p>安装ruby</p>
<p>安装jekyll</p>
<pre><code>gem <span class="keyword">install</span> jekyll
</code></pre><h3 id="使用">使用</h3><p>入门：</p>
<p><code>jekyll new</code> 创建一个新的项目</p>
<p><code>jekyll build</code> 对已存在的项目进行构建，主要是将yaml和md格式的文档转换成html</p>
<p><code>jekyll serve</code> 启动内置服务器，实现本地网站的浏览</p>
<p>进阶：</p>
<p><code>jekyll serve -w</code>  加入 <code>-w</code> 命令，使其支持在运行的过程中热加载，一旦有更新，即刻反映到页面。</p>
<h2 id="flatboot">flatboot</h2><p>Flatboot是对bootstrap做扁平化设计的一个前端框架。</p>
<h2 id="Grunt">Grunt</h2><p>Grunt可以是静态资源的管理，非常适合只有纯静态资源的github-pages博客。</p>
<h3 id="安装-1">安装</h3><ul>
<li>安装Node</li>
<li>安装NPM</li>
<li>安装Grunt</li>
</ul>
<h3 id="使用-1">使用</h3><p><code>grunt init</code> 初始化，会生成<code>Gruntfile.json</code>文件</p>
<p>在<code>Gruntfile.json</code>文件中配置对前端资源文件的处理，如JS、CSS文件的合并，压缩。定制控制命令</p>
<p><code>grunt [command]</code>  运行对应的命令，完成相应操作。</p>
<h2 id="Bower">Bower</h2><p>js库的管理器，通过简单的命令可以实现对项目中引入的JS库进行版本控制和管理。</p>
<h3 id="安装-2">安装</h3><ul>
<li>安装Node</li>
<li>安装NPM</li>
<li>安装Bower</li>
</ul>
<h3 id="使用-2">使用</h3><p><code>bower init</code> 初始化功能，主要是生成<code>bower.json</code>文件</p>
<p><code>bower install</code> 读取<code>bower.json</code> 文件，根据其中的<code>dependencies</code>域安装项目所需JS库。</p>
<p><code>.bowerrc</code>   配置<code>bower install</code>下载的js库的存放位置</p>

        

      </div>
    

    
      <div class="post-footer">
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="2013/08/22/monitoring_on_cloudfoundry/">
                Monitoring on Cloud Foundry
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              发表于 2013-08-21
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <h1 id="monitoring_on_cloudfoundry">monitoring on cloudfoundry</h1><h2 id="Introduction">Introduction</h2><p>When mentioned monitoring on cloudfoundry, there are serveral levels to take. For sure, we have to monitor each component of cloudfoundry. Then, we should think about the machine runtime info which surpports cloudfoundry. And last, we also have to take into consideration about monitoring all applications running on cloudfoundry. It can be classified like that:</p>
<pre><code><span class="number">1.</span> machine <span class="string">monitoring :</span> memory usage <span class="regexp">/ CPU utilization /</span> disk size

<span class="number">2.</span> component <span class="string">monitoring :</span> component status <span class="regexp">/ app statisics /</span> user statisics

<span class="number">3.</span> application <span class="string">monitoring :</span> app status <span class="regexp">/ app instances /</span> app bandwidth
</code></pre><p>This chapter, we will talk about how we doing components monitoring on cloudfoundry. First, we will introduce what info consists of components info and try to classify it. Second, we will introduce some methods we are using to fetch components info. Last, we will see the future of components monitoring on cloudfoundry.</p>
<h2 id="Components_Info_for_Monitoring">Components Info for Monitoring</h2><p>As we all know, each architecture has many info, which contains initiate info, runtime info, input info(valid), output info and expection info. But not all of them are useful for monitoring. So what do we operators really care about? Let’s take an example, when you have a cloudfoundry running, what does your manager ask you most. Here may be those high frequency questions:</p>
<pre><code><span class="number">1.</span> Does this cloudfoundry <span class="property">running</span> well? (each component's status) What <span class="keyword">is</span> <span class="keyword">the</span> structure?(location <span class="keyword">and</span> relationship <span class="keyword">of</span> each component)

<span class="number">2.</span> How many users are using our cloudfoundry <span class="keyword">and</span> who are they?(user info)

<span class="number">3.</span> How many apps <span class="property">running</span> <span class="function_start"><span class="keyword">on</span></span> cloudfoundry?(app info)
</code></pre><p>Based on those questions we can pick up those useful info and classify them. The total map is just like that:</p>
<pre><code><span class="string">|-- Components</span>

    <span class="string">|-- basic info</span>

        <span class="string">|-- name</span>

        <span class="string">|-- access uri</span>

        <span class="string">|-- status</span>

        <span class="string">|-- memory usage</span>

        <span class="string">|-- start time</span>

        <span class="string">|-- up time</span>

    <span class="string">|-- Cloud Controllers</span>

    <span class="string">|-- Health Managers</span>

    <span class="string">|-- Service Gateways</span>

        <span class="string">|-- Supported Versions</span>

        <span class="string">|-- Provisioned Services</span>

        <span class="string">|-- Nodes Info</span>

    <span class="string">|-- Routers</span>

        <span class="string">|-- Droplets</span>

        <span class="string">|-- Requests</span>

        <span class="string">|-- Bad Requests</span>

        <span class="string">|-- 2XX Response</span>

    <span class="string">|-- Droplet Execution Agents</span>

        <span class="string">|-- App numbers</span>

        <span class="string">|-- App Memory</span>

    <span class="string">|-- Applications</span>

        <span class="string">|-- Buildpack</span>

        <span class="string">|-- instance</span>

        <span class="string">|-- space name</span>

    <span class="string">|-- Users</span>

        <span class="string">|-- email</span>

        <span class="string">|-- username</span>

        <span class="string">|-- organization name</span>

    <span class="string">|-- Spaces</span>

        <span class="string">|-- space name</span>

        <span class="string">|-- organization name</span>

        <span class="string">|-- running apps</span>

        <span class="string">|-- stoped apps</span>

    <span class="string">|-- Logs</span>

        <span class="string">|-- log path</span>

        <span class="string">|-- size</span>

        <span class="string">|-- content</span>
</code></pre><h2 id="Methods_to_Fetch_Components_Info">Methods to Fetch Components Info</h2><p>There are serveral ways to fetch components info. First, we can fetch each component basic info via varz mechanism, such as component name, access uri, status and so on.<br>Second, we can connect to nats server and subcribe on specific channel to get requested info. And last, we can fetch info from database.</p>
<p>Here is some definitaions before we talking about the details, if you already know them, just ignore it:</p>
<p>The Nats : Message queue used for cf components communication and registration.</p>
<p>The varz interfaces : REST interface exposing all metrics of a cf component.</p>
<p>The DashBoard : it will get data when initiated and display it on a web interface through graphs.</p>
<h3 id="Varz_Interface">Varz Interface</h3><p>The varz infterface is generated by <code>vcap::component</code> module, and it can be overwrited in a specific module, such as health_manager.</p>
<p>Here is the source code of component: <a href="">click</a></p>
<p>In this file, we first initialize a thin server to provide http protocol on two endpoint <code>/varz</code> and <code>/healthz</code>. Then, we will initialize a <code>Varz</code> object and invoke a function <code>update_varz</code> and it will get a dup of <code>safe hash</code> varz.  <code>Safe Hash</code> is a very important structure, which provides thread safety and only one varz for one component.</p>
<p>We can use <code>VCAP::Component.varz[XX] = XXX</code> to set the value of safe hash varz.</p>
<h3 id="Nats_Mechanism">Nats Mechanism</h3><p>Using nats server we can subcribe channels to get many info among components. Such as request <code>vcap.component.discover</code> channel, we can get the address of accessing each components’ varz.</p>
<p>Here is some nats channel address.</p>
<p><a href="https://github.com/nkaviani/cloudfoundry-bluedocs" target="_blank" rel="external">click</a></p>
<p>From this link, you can find all the nats channel and message sequence in cloudfoundry V1 and V2.</p>
<h3 id="Database_Accessing">Database Accessing</h3><p>For database accessing, we need one important thing, the database access address, usually it is like this:</p>
<pre><code><span class="label">postgres:</span>//username:password<span class="localvars">@10</span><span class="number">.1</span><span class="number">.59</span><span class="number">.185</span>/cloud_controller
</code></pre><p>But it is not easy to get this info as security privacy.</p>
<p>After a batch of detection, we find we can get those info via analysing varz info. Next chapter, we will talk about more details.</p>
<p>Then, we can use the database address to fetch the right info easily.</p>
<h2 id="Health_Manager_Enhencement">Health Manager Enhencement</h2><p>This is an example we made on health manager V2. Beacause when we monitoring on cloudfoundry V1, we could get user info from health manager <code>varz</code> endpoint, but when convert into cloud foundry V2, we find that there is no more user info from <code>varz</code> endpoint. So we decide to make a health manager enhencement to expose user info (such as username, email) via <code>varz</code> endpoint.</p>
<p>Here is the procedure:</p>
<p>For health manager enhencement, we add a file named <code>user_info.rb</code> just in <code>lib</code> directory of health manager project. And we add three lines in health_manager.rb, which is :</p>
<pre><code>* Line27 <span class="built_in">require</span> <span class="string">'health_manager/user_info.rb'</span>

* Line64 <span class="property">@user_info</span> = UserInfo.<span class="keyword">new</span>(<span class="property">@varz</span>)

* Line106 <span class="property">@user_info</span>.start
</code></pre><p>In <code>lib/user_info.rb</code> file, we wrote many small function to implement fetch user info and insert it into <code>varz</code> safe hash. Here is the details:</p>
<p>First, we connect nats server and request <code>vcap.component.discover</code> channel, and receive all the response, decode it, then we can get address of accessing each components’ varz.</p>
<pre><code>NATS.<span class="function"><span class="title">request</span><span class="params">(<span class="string">"vcap.component.discover"</span>)</span></span>
</code></pre><p>Second, we will access each varz endpoint via http request to fetch monitoring info. As we want get the database address, we just pick out <code>uaa</code> varz response using regular expression and find uaa database access address.</p>
<pre><code>db = <span class="literal">result</span>[:data][<span class="string">"config"</span>][<span class="string">"uaa"</span>][<span class="string">"object"</span>][<span class="string">"database"</span>]
db_ip_port = /^.*(\d+\.\d+\.\d+\.\d+:\d+).*$/.match(db[<span class="string">"url"</span>])[<span class="number">1</span>]

<span class="keyword">return</span> <span class="string">"postgres://"</span>+ db[<span class="string">"username"</span>] + <span class="string">":"</span> + db[<span class="string">"password"</span>]+ <span class="string">"@"</span> + db_ip_port + <span class="string">"/uaa"</span>
</code></pre><p>Third, we using <code>DataMapper</code>, which is a database access tools to fetch user info.</p>
<pre><code>DataMapper.<span class="function"><span class="title">setup</span><span class="params">(:default, @@uaa_db)</span></span>
users = Users.<span class="function"><span class="title">all</span><span class="params">(:fields =&gt; [:username, :email])</span></span>
</code></pre><blockquote>
<p>Here is a link related to DataMapper document. <a href="http://datamapper.org/docs/" target="_blank" rel="external">Click</a></p>
</blockquote>
<p>Last, we using <code>VCAP::Component.varz.synchronize</code> method to insert user info into varz object.</p>
<pre><code><span class="type">VCAP</span>::<span class="type">Component</span>.varz.synchronize <span class="keyword">do</span>
  <span class="type">VCAP</span>::<span class="type">Component</span>.varz[:users] = <span class="literal">result</span>
<span class="keyword">end</span>
</code></pre><h2 id="Conslusion">Conslusion</h2><p>In conslusion, In this paper we have discussed monitoring on cloudfoundry. We focused on components monitoring and describe different types of info. Then, we talked the mechanism of fetching those info from cloudfoundry, tell a story about updating health_manager’s source code to fetch the request info.</p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/cloudfoundry/">
                #cloudfoundry
              </a>
            
              <a href="/tags/monitoring/">
                #monitoring
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="2013/08/12/chef相关知识/">
                Chef相关知识
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              发表于 2013-08-11
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <h2 id="概述">概述</h2><p>chef是一个自动化部署的工具项目, 类似的有puppet.</p>
<p>官网地址：www.opscode.com <a href="http://www.opscode.com" target="_blank" rel="external">地址</a></p>
<p>chef主要分为两种方式:</p>
<ul>
<li><p>方式一: chef-solo</p>
<ol>
<li><p>chef-solo的原理是自己撰写cookbook, role等代码并配置run_list, 然后通过chef-solo命令按照run_list依次执行不同软件的部署</p>
</li>
<li><p>chef-solo的可定制程度相对比较高, 不过由于代码执行是在统一路径下，使得chef-solo主要用于单机环境的部署</p>
</li>
<li><p>具体的部署方法请见下一节</p>
</li>
</ol>
</li>
<li><p>方式二: chef-server 和 chef-client</p>
<ol>
<li><p>chef-server 和 chef-client 顾名思义是经典的CS架构，这使得多机部署成为可能, 准确来说变得非常简单.</p>
</li>
<li><p>大致流程可以描述为: 通过knife命令, 根据部署规则, 分别连接待部署机器, 植入chef-client进程, chef-client从各个待部署机器上, 向chef-server请求相应的软件包, 并按照特定的配置文件部署自己的机器.</p>
</li>
</ol>
</li>
</ul>
<h2 id="chef-solo入门">chef-solo入门</h2><p>这一章节主要讲述如何建立chef的基础环境并使用chef-solo</p>
<h3 id="安装chef">安装chef</h3><p>主要有</p>
<ol>
<li><p>安装ruby</p>
<p> 通过rvm安装</p>
</li>
<li><p>安装chef</p>
<p> gem install chef</p>
</li>
<li><p>修改chef配置文件</p>
<p> mkdir /chef/solo.rb</p>
</li>
</ol>
<p>新建和编辑文件: solo.rb  该文件是会在chef-solo执行时自动读取, 获得cookbook位置等信息</p>
<pre><code><span class="label">file_cache_path:</span> <span class="string">"/chef-solo/cache"</span>
<span class="label">cook_book_path:</span> [<span class="string">"chef-solo/cookbooks"</span>]
</code></pre><h4 id="使用hello_world的cookbook">使用hello world的cookbook</h4><p>官方的hello world， <a href="https://github.com/opscode-cookbooks/getting-started" target="_blank" rel="external">地址</a></p>
<p>cd chef-solo/cookbooks</p>
<p>git clone git://github.com/opscode-cookbooks/getting-started.git</p>
<p>获得相应的cookbook</p>
<h4 id="运行cookbook">运行cookbook</h4><p>chef-solo 命令介绍</p>
<p>-c —config CONFIG文件  # 配置文件位置, 默认是/etc/chef/solo.rb</p>
<p>-j —json-attributes JSON_ATTRIBS # 任务脚本， 控制执行cookbooks中的哪些任务和变量属性  node.json</p>
<pre><code>{
    "<span class="attribute">run_list</span>": <span class="value">[<span class="string">"recipe[getting-started]"</span>]
</span>}
</code></pre><p>chef-solo -c solo.rb -j node.json<br>-r —recipe-url RECIPE_URL  # recipe的位置, 暂未用到</p>
<h2 id="chef-server的搭建">chef-server的搭建</h2><p>此处主要描述Chef 11 的搭建和基本使用   </p>
<blockquote>
<p>参考: Chef 11 Server: Up and Running <a href="http://www.opscode.com/blog/2013/03/11/chef-11-server-up-and-running/" target="_blank" rel="external">地址</a></p>
</blockquote>
<p>这篇文章主要描述了如何搭建chef-server 11, 并且介绍了chef-server-ctl管理工具的使用</p>
<p>目前我们的实验环境是Ubuntu 12.04 Server系统</p>
<p><strong>注意</strong> Chef Server强烈推荐有域名绑定和域名解析, 这个暂时没有实践, 通过修改/etc/hosts来进行</p>
<h3 id="安装和启动">安装和启动</h3><p>Chef Server 11 的安装真的很简单</p>
<p>首先获得安装包， 执行如下命令即可获得：</p>
<pre><code>wget -O chef-server-<span class="number">11</span>.<span class="keyword">deb</span> http<span class="variable">s:</span>//opscode-omnitruck-release.s3.amazonaws.<span class="keyword">com</span>/ubuntu/<span class="number">12.04</span>/x86_64/chef-server_11.<span class="number">0.6</span>-<span class="number">1</span>.ubuntu.<span class="number">12.04</span>_amd64.<span class="keyword">deb</span>
</code></pre><p>在Ubuntu机器上执行, dpkg命令来安装deb的安装包， 命令如下：</p>
<pre><code>sudo dpkg -<span class="tag">i</span> chef-server-<span class="number">11</span>.deb
</code></pre><p>下面便是执行启动命令, 命令如下， 该命令会对chef-server进行配置和启动</p>
<pre><code>sudo chef-<span class="keyword">server</span>-ctl reconfigure
</code></pre><p>这个命令实质上会运行内嵌的chef-solo及其包含的cookbook, 然后设置好所有必需的环境和软件, 比如Erchef, RabbitMQ, PostgreSQL等</p>
<p>同时我们还可以运行测试用例, 这些用例会检测所有的组件是否正常运行， 执行如下命令即可进行</p>
<pre><code>sudo chef-<span class="keyword">server</span>-ctl test
</code></pre><p>下面便是设置管理员用户</p>
<p>复制默认的管理员的key和校验key到你本地的安装了chef-client的工作系统上, 通过knife为你自己创建一个新用户. Chef Server的密钥文件只能被root用户读取</p>
<pre><code>mkdir ~/.chef

scp root<span class="annotation">@chef</span>-<span class="string">server:</span><span class="regexp">/etc/</span>chef-server<span class="regexp">/admin.pem ~/</span>.chef

scp root<span class="annotation">@chef</span>-<span class="string">server:</span><span class="regexp">/etc/</span>chef-server<span class="regexp">/chef-validator.pem ~/</span>.chef
</code></pre><p>使用<code>knife configure -i</code>可以创建一个初始化的<code>~/.chef/knife.rb</code></p>
<p>执行命令</p>
<pre><code>knife configure -<span class="built_in">i</span>
</code></pre><p>执行结果, 在用户目录下创建一个knife.rb文件</p>
<p>文件并且为你自己新建一个管理员的账号. 请注意在Chef Server的机器上使用FQDN - 全称域名(Fully Qualified Domain Name), 最好可以带上HTTPS. 确认key需要从Chef Server上的<code>/etc/chef-server/chef-validator.pem</code>拷贝到本机的<code>~/.chef</code>. 通过这个key可以使用knife自动化地部署目标节点</p>
<pre><code>% knife configure -i

WARNING: No knife <span class="keyword">configuration</span> <span class="keyword">file</span> found

Where should I put the config <span class="keyword">file</span>? [/home/jtimberman/.chef/knife.rb]

Please enter the chef server URL: [http://chef.example.com:<span class="number">4000</span>] https://chef.example.com

Please enter a name <span class="keyword">for</span> the <span class="keyword">new</span> user: [jtimberman]

Please enter the existing admin name: [admin]

Please enter the location <span class="keyword">of</span> the existing admin<span class="attribute">'s</span> private key: [/etc/chef/admin.pem] .chef/admin.pem

Please enter the validation clientname: [chef-validator]

Please enter the location <span class="keyword">of</span> the validation key: [/etc/chef/validation.pem] .chef/chef-validator.pem

Please enter the path <span class="keyword">to</span> a chef repository (<span class="keyword">or</span> leave blank):

Creating initial API user...

Please enter a password <span class="keyword">for</span> the <span class="keyword">new</span> user:

Created user[jtimberman]

<span class="keyword">Configuration</span> <span class="keyword">file</span> written <span class="keyword">to</span> /home/jtimberman/.chef/knife.rb
</code></pre><p>文件 <code>.chef/knife.rb</code>内配置的格式大致如下：ku</p>
<pre><code><span class="built_in">log</span>_level                :info
<span class="built_in">log</span>_location             STDOUT
node_name                <span class="string">'jtimberman'</span>
client_key               <span class="string">'/home/jtimberman/.chef/jtimberman.pem'</span>
validation_client_name   <span class="string">'chef-validator'</span>
validation_key           <span class="string">'/home/jtimberman/.chef/chef-validator.pem'</span>
chef_server_url          <span class="string">'https://chef-server.example.com'</span>
syntax_check_cache_path  <span class="string">'/home/jtimberman/.chef/syntax_check_cache'</span>
</code></pre><p><strong>注意</strong> <code>cookbook_path</code>没有设置, 默认设置为空, 如果你需要存储本地的cookbook的时候请注意设置.</p>
<p>这个时候Chef Server已经可以使用了. 可以通过knife测试连通性</p>
<p>执行命令：</p>
<pre><code>% knife client <span class="type">list</span>
</code></pre><p>返回结果：</p>
<pre><code>chef-validator
chef-webui
</code></pre><p>执行命令：</p>
<pre><code>% knife user <span class="type">list</span>
</code></pre><p>返回结果：</p>
<pre><code><span class="title">admin</span>
jtimberman
</code></pre><p>在Chef Server以前的版本中，用户是API的客户端. 在Chef 11中, 无论是对于Opscode的公用Server还是自建的私有Server, 用户都是Server上独立的实体</p>
<h3 id="chef-server-ctl">chef-server-ctl</h3><p>chef-server-ctl命令是被用来做Chef Server系统管理的. 它有内置的help参数可以呈现出很多的子命令. 包括之前执行过的重新配置命令和测试命令. 另外, 还有如下其他命令：</p>
<p>获得Chef Server上所有正在运行的服务的命令为：</p>
<pre><code>sudo chef-server-ctl service-<span class="type">list</span>
</code></pre><p>查看服务的状态, 可以用如下命令：</p>
<pre><code>sudo chef-<span class="keyword">server</span>-ctl status
</code></pre><p>其他与管理服务有关的命令比如：hup,int,kill,once,start,stop,term等</p>
<p>这些服务的日志可以通过tail命令进行tail方式的查看. 它还可以通过传递一个服务名称来查看仅仅是这个服务的日志.</p>
<pre><code>sudo chef-<span class="keyword">server</span>-ctl tail
sudo chef-<span class="keyword">server</span>-ctl tail erchef
</code></pre><p>安装完成后, 如果我们重新修改了配置文件, 我们还可以使用<code>reconfigure</code>命令来配置Chef Server.<br>一旦Chef Server被重新配置后, 我们通过show-config来查看它的配置文件.</p>
<pre><code>sudo chef-<span class="keyword">server</span>-ctl show-config
</code></pre><h3 id="文件系统位置">文件系统位置</h3><p>我们尝试将Chef Server安装的位置尽可能的集中在一个地方,而不是分散在文件系统的各个位置.下面列出Chef Server常见的几个位置:</p>
<pre><code>/opt/chef-<span class="built_in">server</span> – 安装包解压的位置

/etc/chef-<span class="built_in">server</span> – 用户API配置文件和密钥文件的位置

/var/opt/chef-<span class="built_in">server</span> – 相关的服务, 诸如RabbitMQ, Nginx, PostgresQL, SOLR索引和其他等都位于该位置

/var/<span class="built_in">log</span>/chef-<span class="built_in">server</span> – 所有的正在运行的服务和它们的日志在位于该位置.
</code></pre><p>系统设计是自我维护主要通过<code>chef-server-ctl</code>命令, 而不是直接修改组件本身</p>
<h3 id="Chef_Server的配置">Chef Server的配置</h3><p>Chef Server 11中主要的配置文件在<code>/etc/chef-server/chef-server.rb</code>. 类似于其他Chef配置文件, 如<code>/etc/chef/client.rb</code>, <code>~/.chef/knife.rb</code>, 它也使用了Ruby DSL. 通过<code>chef-server-ctl reconfigure</code>命令, 他们被定义为在cookook中的一个个的属性值. 如下所示：</p>
<p>在配置文件中, 我们可以控制WebUI是否有效：</p>
<pre><code>default[<span class="link_label">'chef_server'</span>][<span class="link_reference">'chef-server-webui'</span>][<span class="link_label">'enable'</span>] = true
</code></pre><p>可以在<code>/etc/chef-server/chef-server.rb</code>文件中禁止它:</p>
<pre><code>chef_server_webui[<span class="string">'enble'</span>] = <span class="literal">false</span>
</code></pre><p><strong>注意</strong> 在<code>chef-server.rb</code>配置文件中, 属性值的名字使用下划线隔开, 而默认是短横线</p>
<p>同时在对<code>/etc/chef-server/chef-server.rb</code>文件做了任何修改后, 都应该重新配置命令:</p>
<pre><code>chef-<span class="keyword">server</span>-ctl reconfigure
</code></pre><h3 id="chef-workstation的配置">chef-workstation的配置</h3><p>每个chef workstation都必须设置一个chef-repo来跟Chef Server进行交互</p>
<p>设置chef-repo, 可以从github上面clone出来基础代码：</p>
<pre><code>git clone <span class="string">https:</span><span class="comment">//github.com/opscode/chef-repo.git</span>
</code></pre><p>执行结果：</p>
<pre><code>Cloning into <span class="string">'chef-repo'</span><span class="keyword">...</span>
remote: Counting objects: <span class="number">199</span>, done.
remote: Compressing objects: <span class="number">100</span>% (<span class="number">119</span>/<span class="number">119</span>), done.
remote: Total <span class="number">199</span> (delta <span class="number">71</span>), reused <span class="number">160</span> (delta <span class="number">47</span>)
Receiving objects: <span class="number">100</span>% (<span class="number">199</span>/<span class="number">199</span>), <span class="number">30.45</span> KiB, done.
Resolving deltas: <span class="number">100</span>% (<span class="number">71</span>/<span class="number">71</span>), done.
</code></pre><p>chef-repo的目录结构为：</p>
<pre><code><span class="string">|-- chef-repo</span>

    <span class="string">|-- certificates</span>

    <span class="string">|-- config</span>

    <span class="string">|-- cookbooks</span>

    <span class="string">|-- data_bags</span>

    <span class="string">|-- environments</span>

    <span class="string">|-- roles</span>
</code></pre>
        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/chef/">
                #chef
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="2013/08/11/knife命令/">
                knife 命令
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              发表于 2013-08-10
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <h2 id="概述">概述</h2><p>knife是一个命令行工具, 它提供了一个本地的chef库和Chef服务器. Knife可以帮助用户进行如下管理：</p>
<pre><code><span class="bullet">* </span>待部署机器节点Nodes
<span class="bullet">* </span>Cookbook和Recipe
<span class="bullet">* </span>Roles
<span class="bullet">* </span>Json数据
<span class="bullet">* </span>环境数据
<span class="bullet">* </span>chef-client的部署安装
<span class="bullet">* </span>查询chef-server上的索引数据
</code></pre><p>Knife位于chef workstation和chef server之间. 通过REST API同Chef Server进行交互, 这个API也可以被chef client使用. Knife使用RBAC(Role-based authentication controls)基于角色的鉴权控制来跟Chef Server通信. Knife在workstation初始化的时候会被配置好, 配置文件是knife.rb 一般位于用户目录下的<code>~/.chef/knife.rb</code></p>
<p>knife有很多内置的命令, 这些命令一起可以提供很多功能来设置一个机构的所有资源, 如cookbook, nodes, roles, data bags, environments 以及users.</p>
<p>Knife插件可以拓展这些内置的命令.</p>
<p>Knife主要有如下命令：</p>
<pre><code><span class="bullet">* </span>bootstrap 该命令是执行bootstrap操作, 在目标系统上安装chef-client. boostrap操作必须有FQDN的支持

<span class="bullet">* </span>client 该命令是用来管理API的客户端列表和与他们关联的RSA公钥. 通过它可以允许任何实体, 包括chef-client和Knife来访问Chef-Server

<span class="bullet">* </span>configure 该命令用来创建knife.rb和client.rb文件. 用来配置chef workstation和chef nodes

<span class="bullet">* </span>cookbook 该命令用来跟位于Chef Server和本地chef-repo上的cookbook交互

<span class="bullet">* </span>cookbook site 该命令是用来跟位于https://cookbooks.opscode.com上的cookbook交互. 不过如果要写入权限的话得申请公用账号

<span class="bullet">* </span>data bag 该命令是用来管理全局变量的JSON数据

<span class="bullet">* </span>delete 该命令是用来删除Chef Server上的对象

<span class="bullet">* </span>diff 该命令是用来比较Chef Server和本地之间的chef-repo的文件和目录的不同

<span class="bullet">* </span>download 该命令是用来从Chef Server上下载roles, cookbooks, environments, nodes, data bags到当前工作目录

<span class="bullet">* </span>environment 该命令是用来管理Chef Server上的一个机构的环境

<span class="bullet">* </span>exec 该命令是用来执行Ruby脚本, 其上下文环境是chef-client. 该命令是执行一些当前的knife子命令还没有覆盖到的操作

<span class="bullet">* </span>index rebuild 该命令是用来执行在Chef Server上重建搜索索引. 这个操作会花费一些时间

<span class="bullet">* </span>list 该命令是用来查看Chef Server上的对象列表

<span class="bullet">* </span>node 该命令是用来管理Chef Server上的node列表

<span class="bullet">* </span>recipe list 该命令是用来查看Chef Server上所有的recipes. 此处可以通过简单的正则表达式来查看recipe. 

<span class="bullet">* </span>role 该命令用来管理Chef Server上的跟nodes关联的各种角色

<span class="bullet">* </span>search 该命令用来执行在Chef Server上执行一个搜索查询语句

<span class="bullet">* </span>show 该命令是用来查看Chef Server一个或多个对象的详细信息

<span class="bullet">* </span>ssh 该命令是用来在一个组织的一个或多个节点上执行SSH命令(支持并发), 这些节点可以是基于查询拿到的结果值

<span class="bullet">* </span>status 该命令是用来呈现Chef Server的概要信息, 主要包括最近的成功运行的chef-client信息

<span class="bullet">* </span>tag 该命令是用来在Chef Server上应用tags到nodes

<span class="bullet">* </span>upload 该命令是用来从当前工作路径的chef-repo上传roles, cookbooks, environments和data bags到Chef Server.

<span class="bullet">* </span>user 该命令是用来管理用户列表和他们的RSA公钥对
</code></pre><p>Knife包含一系列的由动词组成的子命令: delete, deps, diff, download, edit, list, show, upload, xargs. 这些子命令允许Knife通过这些命令跟存储在chef-repo里或Chef Server内的任何对象进行交互. 这些子命令的重要的准则主要如下：</p>
<pre><code>* 当命令用在chef-repo的对象上时, 命令首先是目标行为: 也就是上面的verb, 然后是对象所在的目录, 如(clients, cookbooks/,data_bags/, environments/, nodes, roles/, users/). 命令可以组成为: download cookbooks/

* 当命令作用在外部的Chef <span class="built_in">Server</span>上时, 主要操作acls, groups, containers等

* 当把Chef <span class="built_in">Server</span>看成是一个文件系统时, 可以将Chef <span class="built_in">Server</span>上的chef-repo看成是workstation上的一个chef-repo备份. Chef <span class="built_in">Server</span>会有跟本地一样的chef-repo. 在修改文件时, 只需要从Chef <span class="built_in">Server</span>上下载下来， 修改后，再上传上去

* 运行命令的时候要注意上下文环境. 比如当在roles目录下shi, Knife会有上下文环境的嘻嘻你. 即输入knife show base.json和输入knife show roles/base.json显示的信息一样, 都是返回Chef <span class="built_in">Server</span>上的基本角色.

* Chef <span class="built_in">Server</span>支持并发的请求，不过得基于每个指令的配置
</code></pre><h2 id="Knife命令的基础参数">Knife命令的基础参数</h2><p>以下这些参数可以在knife的任何一个子命令中或插件中有效:</p>
<p>-c CONFIG, —config CONFIG   设置配置文件</p>
<p>—color  指明输出的颜色</p>
<p>-d, —disable-editing   指明$EDITOR不会被使用, 呈现出最原始的数据</p>
<p>—defaults 指明Knife将使用默认值, 而不是用户提供的</p>
<p>-e EDITOR, —editor EDITOR 指明$EDITOR在所有交互命令中被使用</p>
<p>-E ENVIRONMENT, —environment ENVIRONMENT 环境名. 当这个参数被添加时, 命令将只会运行被指明的环境名</p>
<p>-f FILE_NAME, —file FILE_NAME 指明私有密钥会被存储的文件</p>
<p>-F FORMAT, —format FORMAT  指明输出文件格式: summary(默认), text, json, yaml 和 pp</p>
<p>-h, —help 显示help信息</p>
<p>-k KEY, —key KEY Knife将会使用的跟Chef Server通信的私有密钥</p>
<p>—no-color 指明输出不会有颜色区分</p>
<p>-p PASSWORD, —password PASSWORD  用户密码</p>
<p>—print-after 指明shuu会在解构后显示</p>
<p>-s URL, —server-url URL Cher Server的URL地址</p>
<p>-u USER, —user USER Knife用来登录Chef Server的用户名, 如果该参数被使用后，请确定带的key也是该用户的, 否则会失败</p>
<p>-v, —version  Chef-Client的版本</p>
<p>-V, —verbose  设置更多的输出 -VV是最大输出</p>
<p>-y, —yes 指明会对所有的确认操作回答”yes”, Knife可以不用向用户确认</p>
<h2 id="如何创建一个chef-repo">如何创建一个chef-repo</h2><p>主要有如下几个方法:</p>
<pre><code><span class="bullet">* </span>从github上clone下来
<span class="bullet">* </span>下载源码包, 然后放到本地的源码管理上
</code></pre><p><strong>注意</strong> Opscode强烈建议在chef-repo目录上使用源码管理. Opscode使用git来管理所有东西, 包括cookbooks.</p>
<h3 id="Clone">Clone</h3><p>clone的位置：<a href="https://github.com/opscode/chef-repo" target="_blank" rel="external">https://github.com/opscode/chef-repo</a></p>
<p>大致步骤：</p>
<pre><code><span class="bullet">1. </span>安装git
<span class="bullet">2. </span>git clone https://github.com/opscode/chef-repo
<span class="bullet">3. </span>如果使用其他源码管理工具, 可以手动移除.git目录,然后用其他工具对其进行初始化
</code></pre><h3 id="下载">下载</h3><p>大致步骤：</p>
<pre><code><span class="bullet">1. </span>wget http://github.com/opscode/chef-repo/tarball/master
<span class="bullet">2. </span>tar -zxvf master
<span class="bullet">3. </span>mv opscode-chef-repo-* chef-repo
</code></pre><h3 id="TODO_待阅读资料">TODO 待阅读资料</h3><p>创建chef-repo  <a href="http://docs.opscode.com/essentials_repository_create.html" target="_blank" rel="external">http://docs.opscode.com/essentials_repository_create.html</a></p>
<p>Knife的基础命令  <a href="http://docs.opscode.com/knife_common_options.html" target="_blank" rel="external">http://docs.opscode.com/knife_common_options.html</a></p>
<p>使用Knife   <a href="http://docs.opscode.com/knife_using.html" target="_blank" rel="external">http://docs.opscode.com/knife_using.html</a> 正在阅读 未完成</p>
<p>Knife的子命令介绍  <a href="http://docs.opscode.com/knife.html" target="_blank" rel="external">http://docs.opscode.com/knife.html</a>   重点弄明白如何下载一个cookbook, 如何自制一个cookbook, 如何向node节点传送一个cookbook</p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/chef/">
                #chef
              </a>
            
              <a href="/tags/knife/">
                #knife
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="2013/08/05/uaa_varz相关/">
                Uaa Varz 相关
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              发表于 2013-08-04
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <h1 id="用户账号和鉴权服务API">用户账号和鉴权服务API</h1><h1 id="概述">概述</h1><p>用户账户和鉴权服务(UAA):</p>
<ul>
<li>从CC提出来的一个单独的应用</li>
<li>拥有用户账户和鉴权源码</li>
<li>通过JSON的方式调用</li>
<li>支持标准的协议以向web应用提供单点登录(single sign-on)和权限委派(delegated authorization), 并且JSON API支持CC和CF的团队特性</li>
<li>支持APIs和基本的登录和授权(login/approval)的界面</li>
<li>支持外部WEB界面的用户账号管理的APIs</li>
</ul>
<p>大部分的API都是遵照OAuth2/OpenID Connect/SCIM标准</p>
<h1 id="配置参数">配置参数</h1><p>一些操作模型和可选的特性可以通过配置文件来设置. 通过改变环境变量和系统属性可以设置很多标准化的脚本</p>
<ul>
<li><p>内部的username/password 鉴权源</p>
<p>  UAA管理一个用户账户数据库. 这些账户可以通过基于密码的鉴权方式被使用, 这个类似于现存的CF用户账户. UAA</p>
</li>
<li><p>其他的鉴权源</p>
<p>  其他的标准外部鉴权源也可以被使用. 最通用的是LDAP服务器, 或者一个外部的OpenID提供者. 其他的认证源可以是水平应用管理器, 比如OAuth2或者SAML协议。SAML2支持暂时还不在计划列表中, 但是很快会被开发.</p>
</li>
</ul>
<h1 id="鉴权和授权的认证APIs">鉴权和授权的认证APIs</h1><p>这一节处理机器之间的联调, 而不是浏览器, 尽管他们中的有些可能有认真用户可以通过浏览器访问的内容. 所有机器的请求都接受JSON格式的Header</p>
<p><code>/userinfo</code> <code>/check_id</code>和<code>/token</code>这些访问点在<code>OpenID Connect</code> 和 <code>OAuth2</code>标准中被指定, 并且应该被CF实例的web应用使用, 比如micro, www, support, 但是不能被vmc使用</p>
<h1 id="OAuth范围">OAuth范围</h1><p>OAuth2的定义里面有一个scope参数的作为token授权请求的一部分, 该授权包含了一堆的scope变量.</p>
<p>范围变量是完全任意的并且可以被任何资源服务器通过token取得</p>
<ol>
<li><p>在客户端注册的时候有可选的步骤，客户端声明它要请求哪一个scopes或者鉴权服务器来限制它可以请求的scopes. 然后鉴权服务器便会检查包含合法scope的token请求.</p>
</li>
<li><p>每一个资源服务器都有一个唯一的ID, 比如一个URI. 并且另一个在客户端注册时可选的部分是提供一个允许资源的列表给询问的客户端. 鉴权服务器将token同允许的资源id绑定, 并且通过<code>/check_token</code>的URL来提供信息, 这样资源服务器可以在提供资源前检查它们自己的ID同token的绑定是不是在允许的列表中.</p>
</li>
<li><p>资源ID有scope一些字符, 除非客户端不需要知道这些信息, 这些信息会在鉴权服务器和资源服务器之间交换. 这个文档中的示例使用<code>scope</code>参数来标识一个资源服务器. 比如： 一个Cloud Controller实例. </p>
</li>
</ol>
<h1 id="鉴权码的授权">鉴权码的授权</h1><p>OAuth2定义的实现<br>干货来了, 重点标注一下<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="header">浏览器请求码: `GET /oauth/authorize`</span><br><span class="line">~~~~~~~~~~~~~~~~~~</span></span><br></pre></td></tr></table></figure></p>
<p><em>HTML响应码</em></p>
<ul>
<li>请求: <code>GET /oauth/authorize</code></li>
<li><p>请求体: spec中规定的一些参数, 再加上<code>application/x-www-form-urlencoded</code>格式的查询模块</p>
<ul>
<li><code>response_type=code</code></li>
<li><code>client_id=www</code></li>
<li><code>scope=read write password</code></li>
<li><code>redirect_uri</code>是可选的, 因为可以预先注册</li>
</ul>
</li>
<li><p>请求头：</p>
<ul>
<li><code>Cookie:JSESSIONID=ADHGFKHDSJGFGF; Path /</code> - UAA给客户端的鉴权cookie. 如果用户浏览器没有cookie的话会被跳转到<code>/login</code>, 并且最终会跳转到<code>/oauth/authrize</code></li>
</ul>
</li>
<li><p>响应头： location跟spec里面定义的一样, 包含<code>access_token</code>, 如果成功的话:</p>
<pre><code><span class="status">HTTP/1.1 <span class="number">302</span> Found</span>
<span class="attribute">Location</span>: <span class="string">https://www.cloudfoundry.example.com?code=F45jH</span>
</code></pre></li>
<li><p>响应码:</p>
<pre><code>302 - Found
</code></pre></li>
</ul>
<p>非浏览器请求码: <code>GET /oauth/authorize</code><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;*JSON Response*&#10;&#10;&#22914;&#26524;&#23458;&#25143;&#31471;&#35831;&#27714;&#19968;&#20010;JSON&#30340;&#21709;&#24212;(&#36890;&#36807;`Accept`&#30340;header)&#24182;&#19988;&#29992;&#25143;&#36824;&#27809;&#26377;&#35748;&#21487;&#25480;&#26435;, UAA&#20250;&#21457;&#36865;&#19968;&#20010;&#24102;&#26377;&#19968;&#20123;&#26377;&#29992;&#20449;&#24687;&#30340;JSON&#23545;&#35937;, &#36825;&#20123;&#20869;&#23481;&#21487;&#20197;&#35753;&#29992;&#25143;&#38405;&#35835;&#24182;&#19988;&#35814;&#23613;&#22320;&#35748;&#21487;&#25480;&#26435;.&#10;&#10;&#9;&#9;&#123;&#10;&#9;&#9;&#9;&#34;message&#34;:&#34;To confirm or deny access POST to the following locations with the parameters requested.&#34;&#10;&#9;&#9;&#9;&#34;scopes&#34;:[&#10;&#9;&#9;&#9;&#9;&#123;&#10;&#9;&#9;&#9;&#9;&#9;&#34;text&#34;:&#34;Access your data with scope &#39;openid&#39;&#34;,&#10;&#9;&#9;&#9;&#9;&#9;&#34;code&#34;:&#34;scope.openid&#34;&#10;&#9;&#9;&#9;&#9;&#125;,&#10;&#9;&#9;&#9;&#9;&#123;&#10;&#9;&#9;&#9;&#9;&#9;&#34;text&#34;:&#34;Access your &#39;cloud_controller&#39; resources with scope &#39;read&#39;&#34;,&#10;&#9;&#9;&#9;&#9;&#9;&#34;code&#34;:&#34;scope.cloud_controller.read&#34;&#10;&#9;&#9;&#9;&#9;&#125;&#10;&#9;&#9;&#9;&#9;...&#10;&#9;&#9;&#9;],&#10;&#9;&#9;&#9;&#34;client_id&#34;:&#34;idtestapp&#34;,&#10;&#9;&#9;&#9;&#34;redirect_uri&#34;:&#34;http://nowhere.com&#34;,&#10;&#9;&#9;&#9;&#34;options&#34;:&#123;&#10;&#9;&#9;&#9;&#9;&#34;deny&#34;:&#123;&#10;&#9;&#9;&#9;&#9;&#9;&#34;location&#34;:&#34;https://uaa.cloudfoundry.com/oauth/authorize&#34;,&#10;&#9;&#9;&#9;&#9;&#9;&#34;value&#34;:&#34;false&#34;,&#10;&#9;&#9;&#9;&#9;&#9;&#34;path&#34;:&#34;/oauth/authorize&#34;,&#10;&#9;&#9;&#9;&#9;&#9;&#34;key&#34;:&#34;user_oauth_approval&#34;&#10;&#9;&#9;&#9;&#9;&#125;&#65292;&#10;&#9;&#9;&#9;&#9;&#34;confirm&#34;:&#123;&#10;&#9;&#9;&#9;&#9;&#9;&#34;location&#34;:&#34;https://uaa.cloudfoundry.com/oauth/authorize&#34;,&#10;&#9;&#9;&#9;&#9;&#9;&#34;value&#34;:&#34;true&#34;,&#10;&#9;&#9;&#9;&#9;&#9;&#34;path&#34;:&#34;/oauth/authorize&#34;,&#10;&#9;&#9;&#9;&#9;&#9;&#34;key&#34;:&#34;user_oauth_approval&#34;&#10;&#9;&#9;&#9;&#9;&#125;&#10;&#9;&#9;&#9;&#125;&#10;&#9;&#9;&#125;&#10;&#10;&#21019;&#24314;&#19968;&#20010;&#29992;&#25143;&#25480;&#26435;&#39029;&#38754;&#26368;&#26377;&#29992;&#30340;&#20449;&#24687;&#26159;&#35831;&#27714;&#30340;scope&#21015;&#34920;, &#23458;&#25143;&#31471;ID&#21644;&#35831;&#27714;&#36339;&#36716;URI&#10;&#10;&#23458;&#25143;&#31471;&#21253;&#21547;Token: `POST /oauth/token`</span><br></pre></td></tr></table></figure></p>
<p>参见 <code>oauth2 token endpoint</code></p>
<h1 id="管理节点">管理节点</h1><h2 id="基本概念_GET_/varz">基本概念 <code>GET /varz</code></h2><p>鉴权是使用携带配置文件中配置的验证信息的HTTP<br>通过 <code>varz.username</code> 和 <code>varz.password</code>从<code>/varz</code>节点拉取信息</p>
<p>data是通过JMX <code>MBeanServer</code> 暴露出的细节信息</p>
<p>更多详细的信息是通过下面的链接提供</p>
<ul>
<li>Request <code>GET /varz</code></li>
<li><p>响应体：</p>
<pre><code>{
    "<span class="attribute">type</span>": <span class="value"><span class="string">"UAA"</span></span>,
    "<span class="attribute">links</span>": <span class="value">{
        "<span class="attribute">Users</span>": <span class="value"><span class="string">"http://localhost:8080/uaa/varz/Users"</span></span>,
        "<span class="attribute">JMImplementtation</span>":
        <span class="value"><span class="string">"http://localhost:8080/uaa/varz/JMImplement"</span></span>,
        "<span class="attribute">spring.application</span>": <span class="value"><span class="string">"http://localhost:8080/uaa/varz/com.sun.management"</span></span>,
        "<span class="attribute">Catalina</span>": <span class="value"><span class="string">"http://localhost:8080/uaa/varz/Catalina"</span></span>,
        "<span class="attribute">env</span>": <span class="value"><span class="string">"http://localhost:8080/uaa/varz/env"</span></span>,
        "<span class="attribute">java.lang</span>": <span class="value"><span class="string">"http://localhost:8080/uaa/varz/java.lang"</span></span>,
        "<span class="attribute">java.util.logging</span>": <span class="value"><span class="string">"http://localhost:8080/uaa/varz/java.util.logging"</span>
    </span>}</span>,
    "<span class="attribute">mem</span>": <span class="value"><span class="number">191734496</span></span>,
    "<span class="attribute">memory</span>": <span class="value">{
        "<span class="attribute">verbose</span>": <span class="value"><span class="literal">false</span></span>,
        "<span class="attribute">non\_heap\_memory\_usage</span>": <span class="value">{
            "<span class="attribute">max</span>": <span class="value"><span class="number">1845493376</span></span>,
            "<span class="attribute">committed</span>": <span class="value"><span class="number">30834688</span></span>,
            "<span class="attribute">init</span>": <span class="value"><span class="number">19136512</span></span>,
            "<span class="attribute">used</span>": <span class="value"><span class="number">30577744</span>
        </span>}</span>,
        "<span class="attribute">object\_pending\_finalization_count</span>": <span class="value"><span class="number">0</span></span>,
        "<span class="attribute">heap\_memory_usage</span>": <span class="value">{
            "<span class="attribute">max</span>": <span class="value"><span class="number">9022996648</span></span>,
            "<span class="attribute">committed</span>": <span class="value"><span class="number">84475904</span></span>,
            "<span class="attribute">init</span>": <span class="value"><span class="number">63338494</span></span>,
            "<span class="attribute">used</span>": <span class="value"><span class="number">19173496</span>
        </span>}
    </span>}</span>,
    "<span class="attribute">token_store</span>": <span class="value">{
        "<span class="attribute">refresh\_token\_count</span>": <span class="value"><span class="number">0</span></span>,
        "<span class="attribute">access\_token\_count</span>": <span class="value"><span class="number">0</span></span>,
        "<span class="attribute">flush_interval</span>": <span class="value"><span class="number">1000</span>
    </span>}</span>,
    "<span class="attribute">audit_service</span>": <span class="value">{
        "<span class="attribute">user\_authentication\_count</span>": <span class="value"><span class="number">0</span></span>,
        "<span class="attribute">user\_not\_fount\_count</span>": <span class="value"><span class="number">0</span></span>,
        "<span class="attribute">principal\_authentication\_failure\_count</span>": <span class="value"><span class="number">1</span></span>,
        "<span class="attribute">user\_authentication\_failure\_count</span>": <span class="value"><span class="number">0</span>
    </span>}
    <span class="string">"spring.profiles.active"</span>: []
</span>}
</code></pre></li>
</ul>
<h2 id="详细的概念_GET_/varz/{domain}">详细的概念  <code>GET /varz/{domain}</code></h2><p>更多详细的信息可以通过<code>/varz</code>后面的link取得</p>
<p><code>/varz/env</code> 链接是高层的JMX的<code>MBeanServer</code>域名信息</p>
<p><code>/varz/Catalina</code> 对于对象图中有一些已知的循环, 我们可以避免</p>
<ul>
<li>请求: <code>GET /varz/{domain}</code></li>
<li><p>响应体 (domain=Catalina)</p>
<pre><code>{
    "<span class="attribute">global\_request\_processor</span>": <span class="value">{
        "<span class="attribute">http-8080</span>": <span class="value">{
            "<span class="attribute">processing_time</span>": <span class="value"><span class="number">0</span></span>,
            "<span class="attribute">max_time</span>": <span class="value"><span class="number">0</span></span>,
            "<span class="attribute">request_count</span>": <span class="value"><span class="number">0</span></span>,
            "<span class="attribute">bytes_sent</span>": <span class="value"><span class="number">0</span></span>,
            "<span class="attribute">bytes_received</span>": <span class="value"><span class="number">0</span></span>,
            "<span class="attribute">error_count</span>": <span class="value"><span class="number">0</span></span>,
            "<span class="attribute">modeler_type</span>": <span class="value"><span class="string">"org.apache.coyote.RequestGroupInfo"</span>
        </span>}
    </span>}</span>
</code></pre></li>
</ul>
<pre><code>}
</code></pre><p>Spring应用的Beans通过<code>/varz/spring.application</code>暴露出来</p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/uaa/">
                #uaa
              </a>
            
              <a href="/tags/varz/">
                #varz
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="2013/07/21/micro-paas在CentOS6上安装/">
                micro-paas 在 CentOS6 上安装
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              发表于 2013-07-20
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>参考资料</p>
<ul>
<li><a href="https://github.com/youdao-cf/docs/tree/master/install" target="_blank" rel="external">有道CF组的CentOS 6安装文档</a></li>
</ul>
<h4 id="1-1_nats安装">1.1 nats安装</h4><p>build.rb步骤</p>
<pre><code><span class="bullet">* </span>安装ruby   # 可以先尝试yum安装  而后尝试编译安装, 具体可以参考[<span class="link_label">网址</span>](<span class="link_url">https://github.com/limengyun2008/vcap/blob/yae/dev_setup/cookbooks/ruby/libraries/ruby_install.rb</span>)

<span class="bullet">* </span>git clone http://git.ebcloud.com/paas-cf-v2/nats.git  # 自行寻找详细地址
<span class="bullet">* </span>git checkout  #固定版本
<span class="bullet">* </span>git submodule update --init   # 进行子模块更新
</code></pre><p>control.rb步骤</p>
<pre><code><span class="keyword">*</span> 生成nats的配置文件

<span class="keyword">*</span> ./bin/nats-server -d -c router.yml   <span class="comment"># 执行启动命令 -d命令是启动debug</span>
</code></pre><h4 id="1-2_gorouter安装">1.2 gorouter安装</h4><p>build.rb步骤</p>
<pre><code><span class="keyword">*</span> go语言环境    <span class="comment"># 推荐寻找yum安装的方式</span>

<span class="keyword">*</span> git clone http://git.ebcloud.com/paas-cf-v2/gorouter.git
<span class="keyword">*</span> git checkout  <span class="comment">#固定版本</span>
<span class="keyword">*</span> git submodule update --init   <span class="comment"># 进行子模块更新</span>

<span class="keyword">*</span> ./bin/go install router/router   <span class="comment"># router构建</span>
</code></pre><p>control.rb步骤</p>
<pre><code>* 修改<span class="keyword">router</span>的配置文件

* ./bin/<span class="keyword">router</span> -c <span class="keyword">router</span>.yml   <span class="comment"># 执行启动命令</span>
</code></pre><h4 id="1-3_uaa安装">1.3 uaa安装</h4><p>build.rb步骤</p>
<pre><code><span class="keyword">*</span> 安装java和maven环境

<span class="keyword">*</span> 安装postgres数据库    <span class="comment"># 此处不推荐用yum安装, 安装的版本可能不对, 版本务必统一为9.2.4, 最好编译安装, 如果遇到问题再一起研究</span>
<span class="keyword">*</span> 编译citext拓展  <span class="comment"># 这个CC数据库需要用到</span>

<span class="keyword">*</span> git clone http://git.ebcloud.com/paas-cf-v2/uaa.git
<span class="keyword">*</span> git checkout  <span class="comment">#固定版本</span>
<span class="keyword">*</span> git submodule update --init   <span class="comment"># 进行子模块更新</span>

<span class="keyword">*</span> 删除bin/uaa里面的<span class="string">"-P vcap"</span>这一块，是对uaa启动代码进行hack
<span class="keyword">*</span> 调整maven repo的位置
</code></pre><p>control.rb步骤</p>
<pre><code><span class="keyword">*</span> 判断是否第一次执行
    如果是 创建uaa数据库 并创建访问uaa数据库的root角色

<span class="keyword">*</span> 修改uaa的配置文件

<span class="keyword">*</span> bin/uaa   <span class="comment"># 执行启动命令</span>
</code></pre><h4 id="1-4_cloud_controller安装">1.4 cloud_controller安装</h4><p>build.rb步骤</p>
<pre><code><span class="keyword">*</span> git clone http://git.ebcloud.com/paas-cf-v2/cloud_controller_ng.git
<span class="keyword">*</span> git checkout  <span class="comment">#固定版本</span>
<span class="keyword">*</span> git submodule update --init   <span class="comment"># 进行子模块更新</span>

<span class="keyword">*</span> 安装基础库，主要包括libxml2-dev libmysql libsqlite libpq 它们分别是xml/mysql/sqlte/postgres的ruby支持
不过在redhat下面的支持库不是以lib为前缀， 尝试执行
sudo yum -y install mysql-devel postgresql-devel sqlite-devel

<span class="keyword">*</span> bundle install
</code></pre><p>control.rb步骤</p>
<pre><code><span class="comment">* 判断是否第一次执行</span>
    如果是 创建<span class="keyword">CC</span>数据库 并创建访问<span class="keyword">CC</span>数据库的root角色

<span class="comment">* 修改cloud_controller的配置文件</span>

<span class="comment">* bin/cloud_controller   # 执行启动命令</span>
</code></pre><h4 id="1-5_health_manager安装">1.5 health_manager安装</h4><p>build.rb步骤</p>
<pre><code><span class="keyword">*</span> git clone http://git.ebcloud.com/paas-cf-v2/health_manager.git
<span class="keyword">*</span> git checkout  <span class="comment"># 固定版本</span>

<span class="keyword">*</span> bundle install
</code></pre><p>control.rb步骤</p>
<pre><code><span class="keyword">*</span> 修改health_manager的配置文件

<span class="keyword">*</span> 设置BUNDLE_GEMFILE的env
<span class="keyword">*</span> ./health_manager   <span class="comment"># 执行启动命令 health_manager必须要到bin目录下执行, 不能通过bin/health_manager执行</span>
</code></pre><h4 id="1-6_dea安装">1.6 dea安装</h4><p>build.rb步骤</p>
<pre><code><span class="bullet">* </span>先安装warden 参考之前的ubuntu下的build和control   TODO  考虑平台问题debootstrap quota apparmor-profiles在CentOS下是什么？具体请参考[<span class="link_label">网址</span>](<span class="link_url">https://github.com/youdao-cf/docs/blob/master/install/warden.html.md</span>)

<span class="bullet">* </span>git clone http://git.ebcloud.com/paas-cf-v2/dea_ng.git
<span class="bullet">* </span>git checkout  #固定版本
<span class="bullet">* </span>git submodule update --init   # 进行子模块更新

<span class="bullet">* </span>bundle install  # 如果带false参数 表示当前项目下的Gemfile中的test/production等group不会被调用

<span class="bullet">* </span>go/bin/go get launchpad.net/goyaml   # 这一步是干什么

<span class="bullet">* </span>bundle exec rake dir<span class="emphasis">_server:install  # 安装directory_</span>server

<span class="bullet">* </span>修改buildpack获取语言包的位置
</code></pre><p>control.rb步骤</p>
<pre><code><span class="keyword">*</span> 修改dea的配置文件

<span class="keyword">*</span> bin/dea config_file   <span class="comment"># 之前需要先启动warden directory_server</span>
</code></pre><h4 id="1-7_service安装">1.7 service安装</h4><p>build.rb步骤</p>
<pre><code><span class="keyword">*</span> 预先安装mysql    <span class="comment"># 可以先用yum安装, 再编译安装  不过得注意版本统一</span>
<span class="keyword">*</span> 预先安装redis    <span class="comment"># 编译安装即可</span>

<span class="keyword">*</span> git clone http://git.ebcloud.com/paas-cf-v2/cf-services-release.git
<span class="keyword">*</span> git checkout  <span class="comment"># 固定版本</span>
<span class="keyword">*</span> git submodule update --init  <span class="comment"># 进行子模块更新</span>

<span class="keyword">*</span> bundle install
</code></pre><p>control.rb步骤</p>
<pre><code><span class="bullet">* </span>修改mysql<span class="emphasis">_gateway 和 mysql_</span>node 的配置文件

<span class="bullet">* </span>bin/mysql<span class="emphasis">_gateway config_</span>file
<span class="bullet">* </span>bin/mysql<span class="emphasis">_node config_</span>file
</code></pre>
        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/centos/">
                #centos
              </a>
            
              <a href="/tags/micro-paas/">
                #micro-paas
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="2013/07/20/cloudfoundry_ppt总结/">
                Cloud Foundry PPT 总结
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              发表于 2013-07-19
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <h1 id="cloud_foundry_ppt总结">cloud foundry ppt总结</h1><h2 id="CFv2_Intro_俞勇_vmware">CFv2 Intro  俞勇 vmware</h2><p><a href="http://vdisk.weibo.com/s/KF4II/1374238063" target="_blank" rel="external">ppt地址</a></p>
<h3 id="1-_Cloud_foundry_V2版的主要更新">1. Cloud foundry V2版的主要更新</h3><h4 id="1-1_Go_Router">1.1 Go Router</h4><p>支持WebSocket以及其他方式   是指带Nginx或不带Nginx?</p>
<p>支持/varz和/healthz路由的http监控</p>
<p>Roadmap路线图</p>
<pre><code>* HTTP Connect support  HTTP连接支持
* Non-HTTP protocols 非HTTP协议支持
* App-specific metric gathering    应用特定信息收集
    <span class="string">|-- Throught                   吞吐量</span>
    <span class="string">|-- Latency                    延时</span>
    <span class="string">|-- Bandwidth                  带宽</span>
    <span class="string">|-- HTTP Reponse codes        HTTP响应码</span>
</code></pre><h4 id="1-2_DEA">1.2 DEA</h4><p>一个有意思的等式：</p>
<pre><code>Droplet = app <span class="tag">code</span> + runtime + framework + container + scripts
</code></pre><p>Roadmap路线图</p>
<pre><code><span class="bullet">* </span>Placement pools 一个存放实例的池子
<span class="bullet">* </span>Shared runtimes 一个共享的运行时
</code></pre><p>参考资料， 补充： <strong>李梦云</strong>是国内CF Redhat移植的大神， 多关注他的github和博客</p>
<pre><code><span class="string">http:</span><span class="comment">//limengyun.com/cloudfoundry/dea.html</span>
</code></pre><p>通过NATS，DEA同CC交互的例子</p>
<p>DEA启动会在NATS上发布消息</p>
<pre><code><span class="attribute">DEA</span>: NATS.<span class="function">publish</span>(‘dea.start’, <span class="variable">@hello_message_json</span>)
<span class="variable">@hello_message_json</span> for UUID, IP, Port, Version of the DEA
</code></pre><p>CC启动一个Droplet实例时</p>
<p>a. DEA监听NATS 对自己UUID的消息主题进行订阅</p>
<pre><code>DEA: NATS.subscribe(‘dea.<span class="comment">#{UUID}.start’) {|msg|process_dea_start(msg)}</span>
Send message <span class="operator">with</span> <span class="operator">the</span> topic <span class="operator">of</span> “dea.<span class="comment">#{uuid}.start” to start this DEA</span>
</code></pre><p>b. CC通过NATS向DEA发布启动命令</p>
<pre><code>Cloud Controller: NATS.<span class="function"><span class="title">publish</span><span class="params">(‘dea.#{dea_id}.start’,json)</span></span>
DEA get the msg, call <span class="function"><span class="title">process_dea_start</span><span class="params">(msg)</span></span>
msg = droplet_id, instance_index, service, runtime
</code></pre><p>TODO</p>
<h4 id="1-3_Warden">1.3 Warden</h4><p>科普知识：</p>
<ul>
<li><p>源自于<a href="http://en.wikipedia.org/wiki/Cgroups" target="_blank" rel="external">Cgroup</a>, 非硬件类<a href="https://en.wikipedia.org/wiki/Hypervisor" target="_blank" rel="external">Hypervisor</a>的一种隔离技术</p>
</li>
<li><p>Warden是一个孤立的环境，Droplet只可以获得受限的CPU,内存，磁盘访问权限，网络权限</p>
</li>
<li><p>目前在GCE，OpenShift等IaaS/PaaS平台中广泛使用</p>
</li>
<li><p>满足应用隔离要求的同时，获得高性能和伸缩性</p>
</li>
<li><p><strong>不直接使用Cgroup，以确保Cloud Foundry DEA对操作系统无依赖性</strong></p>
</li>
</ul>
<h4 id="1-4_Build_Pack">1.4 Build Pack</h4><p>New CF CLI 新的CF客户端</p>
<pre><code><span class="bullet">* </span>支持http代理?
<span class="bullet">* </span>支持CC<span class="emphasis">_ng的api</span>
</code></pre><p>Org &amp; Space &amp; Users 机构 -&gt; 空间 -&gt; 用户 三层角色结构</p>
<pre><code>* org是CF架构里面最顶级的对象
* 一个机构(org)可以包含多个空间(space)
* 用户可以是机构管理员, 机构审核员 <span class="keyword">...</span> 你能想到的很多的有三层角色组成权限集合
</code></pre><p>大致关系如下：</p>
<pre><code><span class="comment">Org</span>
    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">Domains</span>
        <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">Routes</span> &lt;<span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">Applications</span>
    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">Spaces</span>
        <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">Applications</span> &lt;<span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">Routes</span>
        <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">Services</span>
    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">Users</span>
</code></pre><h4 id="1-5_Customized_domain">1.5 Customized domain</h4><pre><code>* 更新DNS的cname **具体方法?**

* 通过调用<span class="keyword">cd</span>命令可以将`route`和`domain`映射

        <span class="keyword">cf</span> <span class="built_in">map</span>-domain somedomain.<span class="keyword">com</span>
        <span class="keyword">cf</span> <span class="built_in">map</span> sintra-hello foo somedomain.<span class="keyword">com</span>
        <span class="keyword">cf</span> restart sinatra-hell
</code></pre><h4 id="1-6_Customized_Buildpacks">1.6 Customized Buildpacks</h4><p>主要分为三部分：</p>
<pre><code><span class="bullet">* </span>Runtime 运行时 Ruby/Java/Node/Python
<span class="bullet">* </span>Container 容器 Tomcat/Websphere/Karaf
<span class="bullet">* </span>Application .WAR / .rb / .py
</code></pre><p>如何使用</p>
<pre><code><span class="keyword">cf</span> push my-<span class="keyword">new</span>-app --buildpack=gi<span class="variable">t:</span>//github.<span class="keyword">com</span>/johndoe/my-buildpack.git
</code></pre><p>相关资料</p>
<pre><code><span class="bullet">* </span>[<span class="link_label">BuildPacks List</span>](<span class="link_url">https://devcenter.heroku.com/articles/third-party-buildpacks</span>)
<span class="bullet">* </span>[<span class="link_label">buildPack示例</span>](<span class="link_url">https://github.com/cdan/cf-mono-buildpack</span>)
<span class="bullet">* </span>[<span class="link_label">CF的buildpack文档</span>](<span class="link_url">http://docs.cloudfoundry.com/docs/using/deploying-apps/buildpacks.html</span>)
</code></pre><p>开发示例</p>
<p>探测 detect</p>
<pre><code><span class="shebang">#!/usr/bin/env ruby</span>
gemfile_path = File.join ARGV[<span class="number">0</span>], <span class="string">"Gemfile"</span>

<span class="keyword">if</span> File.exist?(gemfile_path)
    puts <span class="string">"Ruby"</span>
    exit <span class="number">0</span>
<span class="keyword">else</span>
    exit <span class="number">1</span>
end
</code></pre><p>编译 compile</p>
<pre><code><span class="comment">#!/usr/bin/env ruby</span>
<span class="comment">#sync output</span>

$<span class="keyword">stdout</span>.sync = <span class="constant">true</span>

build_path = ARGV[<span class="number">0</span>]
cache_path = ARGV[<span class="number">1</span>]

install_ruby

<span class="keyword">private</span>

def install_ruby
    puts <span class="string">"Installing Ruby"</span>
    <span class="comment"># !!! build tasks go here !!!</span>
    <span class="comment"># download ruby to cache_path</span>
    <span class="comment"># install ruby</span>
<span class="function"><span class="keyword">end</span></span>
</code></pre><p>发布 release</p>
<p>config_vars：</p>
<pre><code>{
    <span class="string">"config_vars"</span> =&gt; {}, <span class="comment"># environment variables that should be set</span>
    <span class="string">"default_process_types"</span> =&gt; {} <span class="comment">#</span>
}.to_yaml
</code></pre><p>default_process_types:</p>
<pre><code>{
    <span class="string">"config_vars"</span> =&gt; { <span class="string">"RACK_ENV"</span> =&gt; <span class="string">"production"</span> },
    <span class="string">"default_process_types"</span> =&gt; { <span class="string">"web"</span> =&gt; <span class="string">"bundle exec rackup config.ru -p $PORT"</span> }
}.to_yaml
</code></pre><p>Roadmap 路线图</p>
<pre><code><span class="bullet">* </span>vFabric Import tool    ?
<span class="bullet">* </span>Buildpack manager      buildPack管理器
<span class="bullet">* </span>Enhanced caching       增强的缓存
<span class="bullet">* </span>Version policy         版本管理策略
</code></pre><h4 id="1-7_Service_Connector_(CLI)">1.7 Service Connector (CLI)</h4><p><code>service gateway</code> 提供了一个接口，既可以是本地的、自身的服务， 也可以是外部的第三方服务</p>
<p>服务可以是在<code>service node</code>上面跑的服务如mysql，也可以是第三方的SaaS服务</p>
<p><code>service gateway</code>的功能：</p>
<pre><code><span class="bullet">* </span>广播service catalog
<span class="bullet">* </span>向service_node发布create/delete/bind/unbind的命令
<span class="bullet">* </span>向CC请求现存的服务实例和服务绑定情况, 并在本地做缓存  这个是存在内存中的  <span class="strong">__外链__</span>
<span class="bullet">* </span>孤儿服务管理  孤儿服务是指在node上申请成功，但在CC数据库中没有记录的服务实例
<span class="bullet">* </span>SaaS marketplace gateway   SaaS市场网关
</code></pre><p>RoadMap 路线图</p>
<pre><code><span class="bullet">* </span>API Update   估计是CC同Gateway的交互位置   目前仍然用的是V1接口
<span class="bullet">* </span>Multi-node support  多节点支持
<span class="bullet">* </span>Standalone services 单实例服务
<span class="bullet">* </span>looser coupling     松散耦合
</code></pre><p>Service Connector   ? TODO</p>
<pre><code>* Service type templates : Prompts <span class="keyword">for</span> creating instances known service types such <span class="keyword">as</span> Oracle <span class="keyword">and</span> SQLServer 服务类型模板的支持   对于常见的服务提供
* <span class="keyword">Option</span> <span class="keyword">for</span> a service instances <span class="keyword">shared</span> across spaces   提供跨空间的服务实例共享功能选项
</code></pre><h4 id="1-8_其他">1.8 其他</h4><p>还有两个主要组件CC和UAA， PPT中也有涉及但篇幅不多</p>
<p>UAA的功能</p>
<pre><code>Token <span class="built_in">Server</span>   一般会在HTTP头中得到  TODO增加service的理解
ID <span class="built_in">Server</span> (User management)
OAuth Scopes (Groups)
Login UI
Access auditing
</code></pre><p>UAA Roadmap路线图</p>
<pre><code>LDAP Login <span class="built_in">Server</span>
Active Directory Login <span class="built_in">Server</span>
Horizontally scalable Login <span class="built_in">Server</span>
App User Management Service
</code></pre><p>CC RoadMap</p>
<pre><code>Availability zone aware placement
Configurable network policy
OAuth scope <span class="keyword">and</span> role mapping
Richer auditing <span class="keyword">with</span> queries
OpenStack Swift blob <span class="keyword">configuration</span>
</code></pre><h3 id="2-_其他资讯">2. 其他资讯</h3><p>cloudfoundry Enterprise 企业版即将推出 基于vSphere, 非常容易安装, 自带很多app</p>
<h2 id="Cloudfoundry实践_-_fishbuaa(李梦云)_-_网易有道">Cloudfoundry实践 - fishbuaa(李梦云) - 网易有道</h2><p><a href="http://vdisk.weibo.com/s/KF8sy/1374238526" target="_blank" rel="external">ppt地址</a></p>
<p>主要内容是： 用源码方式部署一个cloudfoundry集群及其中的要点   <strong>这个跟我们组类似</strong></p>
<p>PPT所说的视频： <a href="http://limengyun.com/cloudfoundry/index.html" target="_blank" rel="external">http://limengyun.com/cloudfoundry/index.html</a></p>
<p>PPT中的内容不太多, 而且有较多内容与我们做过的工作重复，更多内容需要参考他的博客理解，根据他的博客，我整理了一些要点：</p>
<ol>
<li><p>ccdb 必须支持transaction</p>
</li>
<li><p>cc同uaa之间是进行的对称加密</p>
</li>
<li><p>Idap 自定义的验证源   即 cloud foundry中的login-server组件</p>
</li>
<li><p>web console 也是对官方的cfoundry进行封装, 同样基于sinatra框架， <a href="https://github.com/limengyun2008/console" target="_blank" rel="external">console地址</a></p>
<pre><code><span class="bullet">* </span>任务队列beanstalkd，解决部署问题
<span class="bullet">* </span>根据guid创建svn目录
</code></pre></li>
<li><p>CF V1.0 同 CF V2.0 的主要区别</p>
<ul>
<li>1.0中router使用的是nginx+lua+ruby server的方式，2.0使用了go语言gorouter，据称支持了websocket且极大提升了性能。</li>
<li>2.0中cloud contoller新增了quota，org，space等新的概念，更方便的进行权限和资源管理。</li>
<li>1.0中为应用打包使用的是stager组件，2.0中移除了该组件，将打包功能加入到dea中，并将所有语言的打包程序以submodule的形式放在buildpacks/vendors 目录下。</li>
<li>完全重写了health manager<br>*1.0里 dea可以独立运行，一个dea负责的所有app都以子进程的形式挂在dea主进程下。但2.0之后dea强依赖于warden提供的安全容器来运行app了</li>
</ul>
</li>
<li><p>小道消息 : 2.0用了go重写了1.0用nginx+lua嵌入脚本的router 改称gorouter 号称比1.0有4X的性能提升，如果属实，go前途无量。</p>
</li>
<li><p>其他可能有用的组件</p>
<p> Syslog Aggregator : 归集log的组件<br> Collector : 监听nats中的各类消息来监控各组件的运行状态</p>
</li>
<li><p>Cloud Controller的主要功能:</p>
<ul>
<li>对apps的增删改读；</li>
<li>启动、停止应用程序；</li>
<li>Staging apps（把apps打包成一个droplet）；   TODO完成</li>
<li>修改应用程序运行环境，包括instance、mem等等；</li>
<li>管理service，包括service与app的绑定等；</li>
<li>Cloud环境的管理；</li>
<li>修改Cloud的用户信息；</li>
<li>查看Cloud Foundry，以及每一个app的log信息。</li>
</ul>
</li>
<li><p>CC和uaa对用户进行认证   主要是uaa在认证用户后生成token，然后用户请求cloud_controller时, 将这个token以request的Authentication header的形式伴随HTTP请求发送, 一个代码示例</p>
<p> REQUEST: GET <a href="http://api.vcap.me/v2/spaces/1136694c-1bc2-495e-9aac-1b89894a6dcc/summary" target="_blank" rel="external">http://api.vcap.me/v2/spaces/1136694c-1bc2-495e-9aac-1b89894a6dcc/summary</a><br> REQUEST_HEADERS:<br>   Accept : application/json<br>   Authorization : bearer eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiIzZjMyMTNmZS1jODMzLTQ4YmMtYTYwZi00ZmM0NTAzODk0ZjAiLCJzdWIiOiJkNmE2M2Q1OC04ZmQ4LTRhNzUtOGZhOC1mNWI2ZDJjOGQwMDAiLCJzY29wZSI6WyJwYXNzd29yZC53cml0ZSIsImNsb3VkX2NvbnRyb2xsZXIud3JpdGUiLCJvcGVuaWQiLCJjbG91ZF9jb250cm9sbGVyLnJlYWQiXSwiY2xpZW50X2lkIjoiY2YiLCJjaWQiOiJjZiIsInVzZXJfaWQiOiJkNmE2M2Q1OC04ZmQ4LTRhNzUtOGZhOC1mNWI2ZDJjOGQwMDAiLCJ1c2VyX25hbWUiOiJsaW15IiwiZW1haWwiOiJsaW15QHJkLm5ldGVhc2UuY29tIiwiaWF0IjoxMzcxMzcyNjQyLCJleHAiOjEzNzE5Nzc0NDIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC91YWEvb2F1dGgvdG9rZW4iLCJhdWQiOlsib3BlbmlkIiwiY2xvdWRfY29udHJvbGxlciIsInBhc3N3b3JkIl19.cd11MxTrbCCpG_5fU9_DV1_bE9Nz_2lQ_c1kari1WXI<br>   Content-Length : 0<br> RESPONSE: [200]<br> RESPONSE_HEADERS:<br>   connection : keep-alive<br>   content-length : 88<br>   content-type : application/json;charset=utf-8<br>   date : Mon, 17 Jun 2013 10:38:41 GMT<br>   server : nginx<br>   x-frame-options : sameorigin<br>   x-vcap-request-id : a9f046ec-9e1d-423d-ae8e-985495504d08<br>   x-xss-protection : 1; mode=block</p>
</li>
<li><p>cloud_controller的数据库 需要事物支持 比如postgresql, 而如果选用mysql的话，请务必使用innodb或其它支持事物处理的引擎， 而默认的Myisam不支持事务。<br>示例请看lib/cloud_controller/rest_controller/model_controller.rb</p>
<pre><code><span class="comment"># Create operation</span>
<span class="function"><span class="keyword">def</span> </span>create
  logger.debug <span class="string">"create: <span class="subst">#{request_attrs}</span>"</span>

  json_msg = <span class="keyword">self</span>.<span class="keyword">class</span><span class="constant">::CreateMessage</span>.decode(body)
  <span class="variable">@request_attrs</span> = json_msg.extract(<span class="symbol">:stringify_keys</span> =&gt; <span class="keyword">true</span>)
  raise <span class="constant">InvalidRequest</span> <span class="keyword">unless</span> request_attrs

  before_create <span class="keyword">if</span> respond_to? <span class="symbol">:before_create</span>
  obj = <span class="keyword">nil</span>
  model.db.transaction <span class="keyword">do</span>
    obj = model.create_from_hash(request_attrs)
    validate_access(<span class="symbol">:create</span>, obj, user, roles)
  <span class="keyword">end</span>

  [
    <span class="constant">HTTP::CREATED</span>,
    { <span class="string">"Location"</span> =&gt; <span class="string">"<span class="subst">#{<span class="keyword">self</span>.<span class="keyword">class</span>.path}</span>/<span class="subst">#{obj.guid}</span>"</span> },
    serialization.render_json(<span class="keyword">self</span>.<span class="keyword">class</span>, obj, <span class="variable">@opts</span>)
  ]
<span class="keyword">end</span>
</code></pre></li>
<li><p>Health Manager (简称HM) 主要负责监控app的状态，确保已经启动的app处于running状态，以及这些app的版本和instance数量是正确的。 这些确保机制主要是通过维护应用状态实现的，每个app有一个Actual State 实际运行状态，用来比较它和app的Desired State 期望状态。 当不匹配的情况出现的时候，就要把app的状态调整到期望状态，比如通过start/stop命令来控制missing/extra的instance。</p>
</li>
<li><p>cloud controller对请求的验证是通过解密在Authorization header中的token来实现的。 UAA可以仅仅起一个token分发者的作用，然后将用户认证的部分委托出去。</p>
<p>cloudfoundry已经替我们考虑到了这一点。 只需要在cloud controller的配置项里配置到login这个配置为自己的登录服务器（假设叫login-server） 再使用cf或者cfoundry api 进行登录都会使用login-server来进行登录验证。</p>
<p>其实登录请求分两种，一种是implicit登陆，即使用命令行客户端登陆的方式，另一种是专门给浏览器使用的登陆逻辑。 为了图省事我们浏览器和客户端都是用了同样的implicit登陆接口，直接把token存在cookie里，仅仅为了测试</p>
</li>
<li><p>dea的概念</p>
<p>在提到buildpack之前 有必要解释一下DEA，dea全称是 droplet execution agency，即执行droplet的代理。</p>
<p>droplet是cloudfoundry自创的一个概念，它是一个app的可运行实例配合实例启停脚本的压缩包。</p>
<p>举例来说，如果我把一个php应用放置在某个路径下，然后将apache配置好，最后写一个启动脚本，然后将apache, php应用代码和启动脚本打成一个压缩包。 在另外一台环境完全相同的机器上，你只需要下载这个压缩包，解压到对应目录下，然后启动脚本，应用就可以完美的复制到这台机器上。 这就是cloudfoundry进行动态扩容的原理和基础。 一个打好压缩包就是一个droplet，打压缩包的程序就叫buildpack，打包的过程叫staging。 不同的应用类型对应的buildpack代码也不同。如果要增加一门cloudfoundry默认不支持的语言或者应用类型，就需要自定义buildpack。</p>
</li>
<li><p><a href="http://www.appfog.com" target="_blank" rel="external">http://www.appfog.com</a> 是一个基于cloudfoundry的paas，他自定义了许多语言的buildpack支持并在github上开源出来（github： <a href="https://github.com/appfog/" target="_blank" rel="external">https://github.com/appfog/</a> ）</p>
</li>
</ol>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/cloudfoundry/">
                #cloudfoundry
              </a>
            
              <a href="/tags/community/">
                #community
              </a>
            
              <a href="/tags/ppt/">
                #ppt
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  

          </div>

          
            <div class="pagination">
              <span class="page-number current">1</span><a class="page-number" href="page/2/">2</a><a class="extend next" rel="next" href="page/2/">&raquo;</a>
            </div>
          
        </div>

        
<div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>

<div id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    

    <div class="site-overview">
      <div class="site-author motion-element">
        <img class="site-author-image" src="images/default_avatar.jpg" alt="clongbupt" />
        <p class="site-author-name">clongbupt</p>
      </div>
      <p class="site-description motion-element">一个不会煮面的码农的自留地</p>
      <div class="site-state motion-element">
        <div class="site-state-item site-state-posts">
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">日志</span>
        </div>
        <div class="site-state-item site-state-tags">
            <span class="site-state-item-count">16</span>
            <span class="site-state-item-name">标签</span>
        </div>
        <div class="site-state-item site-state-pages">
            <span class="site-state-item-count">0</span>
            <span class="site-state-item-name">页面</span>
        </div>
      </div>

      

      <div class="social-info motion-element">
        
      </div>

    </div>

    
  </div>
</div>


      </div>
    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp; 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">clongbupt</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT</a>
</div>





      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $(".fancybox").fancybox();
    });
  </script>

  <script type="text/javascript">
  function hasMobileUA () {
    var nav = window.navigator;
    var ua = nav.userAgent;
    var pa = /iPad|iPhone|Android|Opera Mini|BlackBerry|webOS|UCWEB|Blazer|PSP|IEMobile|Symbian/g;

    return pa.test(ua);
  }

  function isDesktop () {
    return screen.width > 991 && !hasMobileUA();
  }

  function isTablet () {
    return screen.width < 992 && screen.width > 767 && hasMobileUA();
  }

  function isMobile () {
    return screen.width < 767 && hasMobileUA();
  }

  function escapeSelector (selector) {
    return selector.replace(/[!"$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&")
  }
</script>

  

  <script type="text/javascript" src="vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="vendors/velocity/velocity.ui.min.js"></script>

  
  <script type="text/javascript" id="motion.page.home">
    $(document).ready(function () {
      $.Velocity.RunSequence([
        { e: $('.brand'), p: { opacity: 1 }, o: { duration: 100 } },
        { e: $('.logo'), p: { opacity: 1, top: 0 }, o: { duration: 50} },
        { e: $('.site-title'), p: { opacity: 1, top: 0 }, o: { duration: 200, sequenceQueue: false } }
      ]);
      $('.menu-item').velocity('transition.slideDownIn', {display: null});
    });
  </script>


  <script type="text/javascript" id="motion.global">
  $(document).ready(function () {
    var body = $('body');
    var isSidebarVisible = false;
    var sidebarToggle = $('.sidebar-toggle');
    var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
    var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
    var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
    var sidebar = $('.sidebar');

    var SIDEBAR_WIDTH = '320px';
    var SIDEBAR_DISPLAY_DURATION = 300;

    var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

    var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
    var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

    var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine2ndStatusArrow = {width: '90%'};
    var sidebarToogleLine2ndStatusClose = {opacity: 0};

    var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
    var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

    sidebatToggleMotion();
    postsListMotion();
    backToTopMotion();


    $(document)
      .on('sidebar.isShowing', function () {
        isDesktop() && body.velocity(
          {paddingRight: SIDEBAR_WIDTH},
          SIDEBAR_DISPLAY_DURATION
        );
        sidebarContentMotion();
      })
      .on('sidebar.isHiding', function () {});


    function backToTopMotion () {
      var b2top = $('.back-to-top');
      b2top.on('click', function () {
        body.velocity('scroll');
      });
    }

    function sidebarShowMotion () {

      sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
      sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
      sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

      sidebar.velocity({width: SIDEBAR_WIDTH}, {
        duration: SIDEBAR_DISPLAY_DURATION,
        complete: function () {
          sidebar.addClass('sidebar-active');
          sidebar.trigger('sidebar.didShow');
        }
      });
      sidebar.trigger('sidebar.isShowing');
    }

    function sidebarHideMotion () {
      isDesktop() && body.velocity({paddingRight: 0});
      sidebar.velocity('reverse');

      sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
      sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
      sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);

      sidebar.removeClass('sidebar-active');
      sidebar.trigger('sidebar.isHiding');
    };

    function sidebarContentMotion () {
      $('.sidebar .motion-element').velocity(
        'transition.slideRightIn',
        {stagger: 50, drag: true}
      );
    }

    function postsListMotion () {
      $('.post').velocity('transition.slideDownIn', {stagger: 300, drag: true});
    }

    function sidebatToggleMotion () {
      sidebarToggle.on('click', function () {
        isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
        isSidebarVisible = !isSidebarVisible;
      });

      sidebarToggle.hover(function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
      }, function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
      });
    }
  });

</script>





  

  

  
  

  


  
</body>
</html>
