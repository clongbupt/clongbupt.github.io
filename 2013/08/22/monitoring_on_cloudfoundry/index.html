<!doctype html>
<html class="theme-next use-motion">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


  <meta name="google-site-verification" content="VvyjvVXcJQa0QklHipu6pwm2PJGnnchIqX7s5JbbT_0" />



  <link rel="stylesheet" type="text/css" href="../../../../vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="../../../../css/main.css?v=0.3.0rc5"/>


    <meta name="description" content="一个不会煮面的码农的自留地" />





    <link rel="shorticon icon" type="image/x-icon" href="../../../..//favicon.ico?v=0.3.0rc5" />



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?50c15455e37f70aea674ff4a663eef27";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <title> Monitoring on Cloud Foundry // clongbupt的小窝 </title>
</head>

<body>
  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
    <a href="/" class="brand">
        <span class="logo">
          <i class="icon-logo"></i>
        </span>
        <span class="site-title">clongbupt的小窝</span>
    </a>
</h1>


  <ul id="menu" class="menu">
    
      
      <li class="menu-item menu-item-home">
        <a href="../../../..//">
          <i class="menu-item-icon icon-home"></i> <br />
          首页
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="../../../..//archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          归档
        </a>
      </li>
    
      
      <li class="menu-item menu-item-about">
        <a href="../../../..//about">
          <i class="menu-item-icon icon-about"></i> <br />
          关于
        </a>
      </li>
    
      
      <li class="menu-item menu-item-gallery">
        <a href="../../../..//gallery">
          <i class="menu-item-icon icon-gallery"></i> <br />
          menu.gallery
        </a>
      </li>
    
      
      <li class="menu-item menu-item-library">
        <a href="../../../..//library">
          <i class="menu-item-icon icon-library"></i> <br />
          menu.library
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
            
          

          <div id="posts" class="posts-expand">
            
  

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              Monitoring on Cloud Foundry
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              发表于 2013-08-21
            
          </span>
        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2013/08/22/monitoring_on_cloudfoundry/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2013/08/22/monitoring_on_cloudfoundry/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <h1 id="monitoring_on_cloudfoundry">monitoring on cloudfoundry</h1><h2 id="Introduction">Introduction</h2><p>When mentioned monitoring on cloudfoundry, there are serveral levels to take. For sure, we have to monitor each component of cloudfoundry. Then, we should think about the machine runtime info which surpports cloudfoundry. And last, we also have to take into consideration about monitoring all applications running on cloudfoundry. It can be classified like that:</p>
<pre><code><span class="number">1.</span> machine <span class="string">monitoring :</span> memory usage <span class="regexp">/ CPU utilization /</span> disk size

<span class="number">2.</span> component <span class="string">monitoring :</span> component status <span class="regexp">/ app statisics /</span> user statisics

<span class="number">3.</span> application <span class="string">monitoring :</span> app status <span class="regexp">/ app instances /</span> app bandwidth
</code></pre><p>This chapter, we will talk about how we doing components monitoring on cloudfoundry. First, we will introduce what info consists of components info and try to classify it. Second, we will introduce some methods we are using to fetch components info. Last, we will see the future of components monitoring on cloudfoundry.</p>
<h2 id="Components_Info_for_Monitoring">Components Info for Monitoring</h2><p>As we all know, each architecture has many info, which contains initiate info, runtime info, input info(valid), output info and expection info. But not all of them are useful for monitoring. So what do we operators really care about? Let’s take an example, when you have a cloudfoundry running, what does your manager ask you most. Here may be those high frequency questions:</p>
<pre><code><span class="number">1.</span> Does this cloudfoundry <span class="property">running</span> well? (each component's status) What <span class="keyword">is</span> <span class="keyword">the</span> structure?(location <span class="keyword">and</span> relationship <span class="keyword">of</span> each component)

<span class="number">2.</span> How many users are using our cloudfoundry <span class="keyword">and</span> who are they?(user info)

<span class="number">3.</span> How many apps <span class="property">running</span> <span class="function_start"><span class="keyword">on</span></span> cloudfoundry?(app info)
</code></pre><p>Based on those questions we can pick up those useful info and classify them. The total map is just like that:</p>
<pre><code><span class="string">|-- Components</span>

    <span class="string">|-- basic info</span>

        <span class="string">|-- name</span>

        <span class="string">|-- access uri</span>

        <span class="string">|-- status</span>

        <span class="string">|-- memory usage</span>

        <span class="string">|-- start time</span>

        <span class="string">|-- up time</span>

    <span class="string">|-- Cloud Controllers</span>

    <span class="string">|-- Health Managers</span>

    <span class="string">|-- Service Gateways</span>

        <span class="string">|-- Supported Versions</span>

        <span class="string">|-- Provisioned Services</span>

        <span class="string">|-- Nodes Info</span>

    <span class="string">|-- Routers</span>

        <span class="string">|-- Droplets</span>

        <span class="string">|-- Requests</span>

        <span class="string">|-- Bad Requests</span>

        <span class="string">|-- 2XX Response</span>

    <span class="string">|-- Droplet Execution Agents</span>

        <span class="string">|-- App numbers</span>

        <span class="string">|-- App Memory</span>

    <span class="string">|-- Applications</span>

        <span class="string">|-- Buildpack</span>

        <span class="string">|-- instance</span>

        <span class="string">|-- space name</span>

    <span class="string">|-- Users</span>

        <span class="string">|-- email</span>

        <span class="string">|-- username</span>

        <span class="string">|-- organization name</span>

    <span class="string">|-- Spaces</span>

        <span class="string">|-- space name</span>

        <span class="string">|-- organization name</span>

        <span class="string">|-- running apps</span>

        <span class="string">|-- stoped apps</span>

    <span class="string">|-- Logs</span>

        <span class="string">|-- log path</span>

        <span class="string">|-- size</span>

        <span class="string">|-- content</span>
</code></pre><h2 id="Methods_to_Fetch_Components_Info">Methods to Fetch Components Info</h2><p>There are serveral ways to fetch components info. First, we can fetch each component basic info via varz mechanism, such as component name, access uri, status and so on.<br>Second, we can connect to nats server and subcribe on specific channel to get requested info. And last, we can fetch info from database.</p>
<p>Here is some definitaions before we talking about the details, if you already know them, just ignore it:</p>
<p>The Nats : Message queue used for cf components communication and registration.</p>
<p>The varz interfaces : REST interface exposing all metrics of a cf component.</p>
<p>The DashBoard : it will get data when initiated and display it on a web interface through graphs.</p>
<h3 id="Varz_Interface">Varz Interface</h3><p>The varz infterface is generated by <code>vcap::component</code> module, and it can be overwrited in a specific module, such as health_manager.</p>
<p>Here is the source code of component: <a href="">click</a></p>
<p>In this file, we first initialize a thin server to provide http protocol on two endpoint <code>/varz</code> and <code>/healthz</code>. Then, we will initialize a <code>Varz</code> object and invoke a function <code>update_varz</code> and it will get a dup of <code>safe hash</code> varz.  <code>Safe Hash</code> is a very important structure, which provides thread safety and only one varz for one component.</p>
<p>We can use <code>VCAP::Component.varz[XX] = XXX</code> to set the value of safe hash varz.</p>
<h3 id="Nats_Mechanism">Nats Mechanism</h3><p>Using nats server we can subcribe channels to get many info among components. Such as request <code>vcap.component.discover</code> channel, we can get the address of accessing each components’ varz.</p>
<p>Here is some nats channel address.</p>
<p><a href="https://github.com/nkaviani/cloudfoundry-bluedocs" target="_blank" rel="external">click</a></p>
<p>From this link, you can find all the nats channel and message sequence in cloudfoundry V1 and V2.</p>
<h3 id="Database_Accessing">Database Accessing</h3><p>For database accessing, we need one important thing, the database access address, usually it is like this:</p>
<pre><code><span class="label">postgres:</span>//username:password<span class="localvars">@10</span><span class="number">.1</span><span class="number">.59</span><span class="number">.185</span>/cloud_controller
</code></pre><p>But it is not easy to get this info as security privacy.</p>
<p>After a batch of detection, we find we can get those info via analysing varz info. Next chapter, we will talk about more details.</p>
<p>Then, we can use the database address to fetch the right info easily.</p>
<h2 id="Health_Manager_Enhencement">Health Manager Enhencement</h2><p>This is an example we made on health manager V2. Beacause when we monitoring on cloudfoundry V1, we could get user info from health manager <code>varz</code> endpoint, but when convert into cloud foundry V2, we find that there is no more user info from <code>varz</code> endpoint. So we decide to make a health manager enhencement to expose user info (such as username, email) via <code>varz</code> endpoint.</p>
<p>Here is the procedure:</p>
<p>For health manager enhencement, we add a file named <code>user_info.rb</code> just in <code>lib</code> directory of health manager project. And we add three lines in health_manager.rb, which is :</p>
<pre><code>* Line27 <span class="built_in">require</span> <span class="string">'health_manager/user_info.rb'</span>

* Line64 <span class="property">@user_info</span> = UserInfo.<span class="keyword">new</span>(<span class="property">@varz</span>)

* Line106 <span class="property">@user_info</span>.start
</code></pre><p>In <code>lib/user_info.rb</code> file, we wrote many small function to implement fetch user info and insert it into <code>varz</code> safe hash. Here is the details:</p>
<p>First, we connect nats server and request <code>vcap.component.discover</code> channel, and receive all the response, decode it, then we can get address of accessing each components’ varz.</p>
<pre><code>NATS.<span class="function"><span class="title">request</span><span class="params">(<span class="string">"vcap.component.discover"</span>)</span></span>
</code></pre><p>Second, we will access each varz endpoint via http request to fetch monitoring info. As we want get the database address, we just pick out <code>uaa</code> varz response using regular expression and find uaa database access address.</p>
<pre><code>db = <span class="literal">result</span>[:data][<span class="string">"config"</span>][<span class="string">"uaa"</span>][<span class="string">"object"</span>][<span class="string">"database"</span>]
db_ip_port = /^.*(\d+\.\d+\.\d+\.\d+:\d+).*$/.match(db[<span class="string">"url"</span>])[<span class="number">1</span>]

<span class="keyword">return</span> <span class="string">"postgres://"</span>+ db[<span class="string">"username"</span>] + <span class="string">":"</span> + db[<span class="string">"password"</span>]+ <span class="string">"@"</span> + db_ip_port + <span class="string">"/uaa"</span>
</code></pre><p>Third, we using <code>DataMapper</code>, which is a database access tools to fetch user info.</p>
<pre><code>DataMapper.<span class="function"><span class="title">setup</span><span class="params">(:default, @@uaa_db)</span></span>
users = Users.<span class="function"><span class="title">all</span><span class="params">(:fields =&gt; [:username, :email])</span></span>
</code></pre><blockquote>
<p>Here is a link related to DataMapper document. <a href="http://datamapper.org/docs/" target="_blank" rel="external">Click</a></p>
</blockquote>
<p>Last, we using <code>VCAP::Component.varz.synchronize</code> method to insert user info into varz object.</p>
<pre><code><span class="type">VCAP</span>::<span class="type">Component</span>.varz.synchronize <span class="keyword">do</span>
  <span class="type">VCAP</span>::<span class="type">Component</span>.varz[:users] = <span class="literal">result</span>
<span class="keyword">end</span>
</code></pre><h2 id="Conslusion">Conslusion</h2><p>In conslusion, In this paper we have discussed monitoring on cloudfoundry. We focused on components monitoring and describe different types of info. Then, we talked the mechanism of fetching those info from cloudfoundry, tell a story about updating health_manager’s source code to fetch the request info.</p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/cloudfoundry/">
                #cloudfoundry
              </a>
            
              <a href="/tags/monitoring/">
                #monitoring
              </a>
            
          </div>
        

        
          <div class="post-nav">
            <div class="post-nav-prev post-nav-item">
              
                <a href="../../../../2014/04/24/博客搭建架构/">博客搭建架构</a>
              
            </div>

            <div class="post-nav-next post-nav-item">
              
                <a href="../../12/chef相关知识/">Chef相关知识</a>
              
            </div>
          </div>
        

        
        
      </div>
    
  </div>



  
    <div class="comments" id="comments">
      
        <div class="ds-thread" data-thread-key="2013/08/22/monitoring_on_cloudfoundry/"
             data-title="Monitoring on Cloud Foundry" data-url="http://clongbupt.github.io/2013/08/22/monitoring_on_cloudfoundry/">
        </div>

      
    </div>
  

          </div>

          
        </div>

        
<div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>

<div id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview" data-target="site-overview">
          站点概览
        </li>
      </ul>
    

    <div class="site-overview">
      <div class="site-author motion-element">
        <img class="site-author-image" src="../../../../images/default_avatar.jpg" alt="clongbupt" />
        <p class="site-author-name">clongbupt</p>
      </div>
      <p class="site-description motion-element">一个不会煮面的码农的自留地</p>
      <div class="site-state motion-element">
        <div class="site-state-item site-state-posts">
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">日志</span>
        </div>
        <div class="site-state-item site-state-tags">
            <span class="site-state-item-count">16</span>
            <span class="site-state-item-name">标签</span>
        </div>
        <div class="site-state-item site-state-pages">
            <span class="site-state-item-count">3</span>
            <span class="site-state-item-name">页面</span>
        </div>
      </div>

      

      <div class="social-info motion-element">
        
          
            <span class="social-item">
              <a href="https://github.com/clongbupt/">GitHub</a>
            </span>
          
            <span class="social-item">
              <a href="https://facebook.com/clongbupt/">Facebook</a>
            </span>
          
            <span class="social-item">
              <a href="https://twitter.com/clongbupt">Twitter</a>
            </span>
          
            <span class="social-item">
              <a href="http://www.weibo.com/u/1085595672">Weibo</a>
            </span>
          
            <span class="social-item">
              <a href="http://weibo.com/clongbupt">DouBan</a>
            </span>
          
        
      </div>

    </div>

    
      <div class="post-toc sidebar-panel-active">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#monitoring_on_cloudfoundry"><span class="nav-number">1.</span> <span class="nav-text">monitoring on cloudfoundry</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Components_Info_for_Monitoring"><span class="nav-number">1.2.</span> <span class="nav-text">Components Info for Monitoring</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Methods_to_Fetch_Components_Info"><span class="nav-number">1.3.</span> <span class="nav-text">Methods to Fetch Components Info</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Varz_Interface"><span class="nav-number">1.3.1.</span> <span class="nav-text">Varz Interface</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nats_Mechanism"><span class="nav-number">1.3.2.</span> <span class="nav-text">Nats Mechanism</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Database_Accessing"><span class="nav-number">1.3.3.</span> <span class="nav-text">Database Accessing</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Health_Manager_Enhencement"><span class="nav-number">1.4.</span> <span class="nav-text">Health Manager Enhencement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conslusion"><span class="nav-number">1.5.</span> <span class="nav-text">Conslusion</span></a></li></ol></li></ol>
      </div>
    
  </div>
</div>


      </div>
    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp;  2013 - 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">clongbupt</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT</a>
</div>



  <div class="cc-license">
    <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
      <img src="../../../../images/cc-by-nc-sa.svg" alt="Creative Commons" />
    </a>
  </div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="../../../../vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="../../../../vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $(".fancybox").fancybox();
    });
  </script>

  <script type="text/javascript">
  function hasMobileUA () {
    var nav = window.navigator;
    var ua = nav.userAgent;
    var pa = /iPad|iPhone|Android|Opera Mini|BlackBerry|webOS|UCWEB|Blazer|PSP|IEMobile|Symbian/g;

    return pa.test(ua);
  }

  function isDesktop () {
    return screen.width > 991 && !hasMobileUA();
  }

  function isTablet () {
    return screen.width < 992 && screen.width > 767 && hasMobileUA();
  }

  function isMobile () {
    return screen.width < 767 && hasMobileUA();
  }

  function escapeSelector (selector) {
    return selector.replace(/[!"$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&")
  }
</script>

  

  <script type="text/javascript" src="../../../../vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="../../../../vendors/velocity/velocity.ui.min.js"></script>

  

  <script type="text/javascript" id="motion.global">
  $(document).ready(function () {
    var body = $('body');
    var isSidebarVisible = false;
    var sidebarToggle = $('.sidebar-toggle');
    var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
    var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
    var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
    var sidebar = $('.sidebar');

    var SIDEBAR_WIDTH = '320px';
    var SIDEBAR_DISPLAY_DURATION = 300;

    var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

    var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
    var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

    var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine2ndStatusArrow = {width: '90%'};
    var sidebarToogleLine2ndStatusClose = {opacity: 0};

    var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
    var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

    sidebatToggleMotion();
    postsListMotion();
    backToTopMotion();


    $(document)
      .on('sidebar.isShowing', function () {
        isDesktop() && body.velocity(
          {paddingRight: SIDEBAR_WIDTH},
          SIDEBAR_DISPLAY_DURATION
        );
        sidebarContentMotion();
      })
      .on('sidebar.isHiding', function () {});


    function backToTopMotion () {
      var b2top = $('.back-to-top');
      b2top.on('click', function () {
        body.velocity('scroll');
      });
    }

    function sidebarShowMotion () {

      sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
      sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
      sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

      sidebar.velocity({width: SIDEBAR_WIDTH}, {
        duration: SIDEBAR_DISPLAY_DURATION,
        complete: function () {
          sidebar.addClass('sidebar-active');
          sidebar.trigger('sidebar.didShow');
        }
      });
      sidebar.trigger('sidebar.isShowing');
    }

    function sidebarHideMotion () {
      isDesktop() && body.velocity({paddingRight: 0});
      sidebar.velocity('reverse');

      sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
      sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
      sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);

      sidebar.removeClass('sidebar-active');
      sidebar.trigger('sidebar.isHiding');
    };

    function sidebarContentMotion () {
      $('.sidebar .motion-element').velocity(
        'transition.slideRightIn',
        {stagger: 50, drag: true}
      );
    }

    function postsListMotion () {
      $('.post').velocity('transition.slideDownIn', {stagger: 300, drag: true});
    }

    function sidebatToggleMotion () {
      sidebarToggle.on('click', function () {
        isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
        isSidebarVisible = !isSidebarVisible;
      });

      sidebarToggle.hover(function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
      }, function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
      });
    }
  });

</script>





  
  
<script type="text/javascript" id="bootstrap.scrollspy.custom">
  /* ========================================================================
  * Bootstrap: scrollspy.js v3.3.2
  * http://getbootstrap.com/javascript/#scrollspy
  * ========================================================================
  * Copyright 2011-2015 Twitter, Inc.
  * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
  * ======================================================================== */

  /**
   * Custom by iissnan
   *
   * - Add a `clear.bs.scrollspy` event.
   * - Esacpe targets selector.
   */


  +function ($) {
    'use strict';

    // SCROLLSPY CLASS DEFINITION
    // ==========================

    function ScrollSpy(element, options) {
      this.$body          = $(document.body)
      this.$scrollElement = $(element).is(document.body) ? $(window) : $(element)
      this.options        = $.extend({}, ScrollSpy.DEFAULTS, options)
      this.selector       = (this.options.target || '') + ' .nav li > a'
      this.offsets        = []
      this.targets        = []
      this.activeTarget   = null
      this.scrollHeight   = 0

      this.$scrollElement.on('scroll.bs.scrollspy', $.proxy(this.process, this))
      this.refresh()
      this.process()
    }

    ScrollSpy.VERSION  = '3.3.2'

    ScrollSpy.DEFAULTS = {
      offset: 10
    }

    ScrollSpy.prototype.getScrollHeight = function () {
      return this.$scrollElement[0].scrollHeight || Math.max(this.$body[0].scrollHeight, document.documentElement.scrollHeight)
    }

    ScrollSpy.prototype.refresh = function () {
      var that          = this
      var offsetMethod  = 'offset'
      var offsetBase    = 0

      this.offsets      = []
      this.targets      = []
      this.scrollHeight = this.getScrollHeight()

      if (!$.isWindow(this.$scrollElement[0])) {
        offsetMethod = 'position'
        offsetBase   = this.$scrollElement.scrollTop()
      }

      this.$body
        .find(this.selector)
        .map(function () {
          var $el   = $(this)
          var href  = $el.data('target') || $el.attr('href')
          var $href = /^#./.test(href) && $(escapeSelector(href)) // Need to escape selector.

          return ($href
            && $href.length
            && $href.is(':visible')
            && [[$href[offsetMethod]().top + offsetBase, href]]) || null
        })
        .sort(function (a, b) { return a[0] - b[0] })
        .each(function () {
          that.offsets.push(this[0])
          that.targets.push(this[1])
        })


    }

    ScrollSpy.prototype.process = function () {
      var scrollTop    = this.$scrollElement.scrollTop() + this.options.offset
      var scrollHeight = this.getScrollHeight()
      var maxScroll    = this.options.offset + scrollHeight - this.$scrollElement.height()
      var offsets      = this.offsets
      var targets      = this.targets
      var activeTarget = this.activeTarget
      var i

      if (this.scrollHeight != scrollHeight) {
        this.refresh()
      }

      if (scrollTop >= maxScroll) {
        return activeTarget != (i = targets[targets.length - 1]) && this.activate(i)
      }

      if (activeTarget && scrollTop < offsets[0]) {
        $(this.selector).trigger('clear.bs.scrollspy')  // Add a custom event.
        this.activeTarget = null
        return this.clear()
      }

      for (i = offsets.length; i--;) {
        activeTarget != targets[i]
          && scrollTop >= offsets[i]
          && (!offsets[i + 1] || scrollTop <= offsets[i + 1])
          && this.activate(targets[i])
      }
    }

    ScrollSpy.prototype.activate = function (target) {
      this.activeTarget = target

      this.clear()

      var selector = this.selector +
        '[data-target="' + target + '"],' +
        this.selector + '[href="' + target + '"]'

      var active = $(selector)
        .parents('li')
        .addClass('active')

      if (active.parent('.dropdown-menu').length) {
        active = active
          .closest('li.dropdown')
          .addClass('active')
      }

      active.trigger('activate.bs.scrollspy')
    }

    ScrollSpy.prototype.clear = function () {
      $(this.selector)
        .parentsUntil(this.options.target, '.active')
        .removeClass('active')
    }


    // SCROLLSPY PLUGIN DEFINITION
    // ===========================

    function Plugin(option) {
      return this.each(function () {
        var $this   = $(this)
        var data    = $this.data('bs.scrollspy')
        var options = typeof option == 'object' && option

        if (!data) $this.data('bs.scrollspy', (data = new ScrollSpy(this, options)))
        if (typeof option == 'string') data[option]()
      })
    }

    var old = $.fn.scrollspy

    $.fn.scrollspy             = Plugin
    $.fn.scrollspy.Constructor = ScrollSpy


    // SCROLLSPY NO CONFLICT
    // =====================

    $.fn.scrollspy.noConflict = function () {
      $.fn.scrollspy = old
      return this
    }


    // SCROLLSPY DATA-API
    // ==================

    $(window).on('load.bs.scrollspy.data-api', function () {
      $('[data-spy="scroll"]').each(function () {
        var $spy = $(this)
        Plugin.call($spy, $spy.data())
      })
    })

  }(jQuery);
</script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      $tocSelector.scrollPager({
        max: getTOCMaxHeight()
      });
    }

    function getTOCMaxHeight () {
      // TODO: Make it beautiful
      var $sidebarInner = $('.sidebar-inner');
      var height = $('.sidebar').height() -
        parseInt($sidebarInner.css('padding-top'), 10) -
        parseInt($sidebarInner.css('padding-bottom'), 10) -
        $('.sidebar-nav').height() -
        parseInt($tocSelector.css('margin-top'), 10) -
        parseInt($tocSelector.css('margin-bottom'), 10);

      $tocSelector.css('height', height);

      return height;
    }

    $(document).on('sidebar.didShow', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();
      });
    }
  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      if ($('.post-toc').html().trim().length > 0 && isDesktop()) {
        setTimeout(function () {
          $('.sidebar-toggle').trigger('click');
        }, 800);
      }
    });
  </script>




  

  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"your-duoshuo-shortname"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
  
</body>
</html>
